<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    
    <title>斯坦福大学iOS开发公开课总结（十四 十五）：CoreLocation，MapKit，在地图上标识Flickr摄影师的作品 | Knight_SJ</title>
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="description" content="在学hybrid开发的iOS开发者">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="斯坦福大学iOS开发公开课总结（十四 十五）：CoreLocation，MapKit，在地图上标识Flickr摄影师的作品 | Knight_SJ">
    <meta name="twitter:description" content="在学hybrid开发的iOS开发者">

    <meta property="og:type" content="article">
    <meta property="og:title" content="斯坦福大学iOS开发公开课总结（十四 十五）：CoreLocation，MapKit，在地图上标识Flickr摄影师的作品 | Knight_SJ">
    <meta property="og:description" content="在学hybrid开发的iOS开发者">

    
    <meta name="author" content="Knight_SJ">
    
    <link rel="stylesheet" href="/css/vno.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css">

    
    <link rel="icon" href="/images/avatar.png">
    

    <meta name="generator" content="hexo"/>
    
    <link rel="alternate" type="application/rss+xml" title="Knight_SJ" href="/atom.xml">
    

    <link rel="canonical" href="https://github.com/knightsj/knightsj.github.io/2017/01/11/斯坦福大学iOS开发公开课总结（十四 十五）：CoreLocation，MapKit，在地图上标识Flickr摄影师的作品/"/>

    
      
</head>

<body class="home-template no-js">
    <script src="//cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <span class="mobile btn-mobile-menu">
        <i class="fa fa-list btn-mobile-menu__icon"></i>
        <i class="fa fa-angle-up btn-mobile-close__icon hidden"></i>
    </span>

    
<header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/bg_2.jpg)">
  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        <a href="/" title="前往 Knight_SJ 的主页"><img src="/images/avatar.png" width="80" alt="Knight_SJ logo" class="panel-cover__logo logo" /></a>
        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage for Knight_SJ">Knight_SJ</a></h1>
        
        <span class="panel-cover__subtitle panel-subtitle">iOS开发|上海</span>
        
        <hr class="panel-cover__divider" />
        <p class="panel-cover__description">在学hybrid开发的iOS开发者</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />

        <div class="navigation-wrapper">
          <div>
          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item"><a href="/#blog" title="访问博客" class="blog-button">博客</a></li>
            
            </ul>
          </nav>
          </div>
          <div>
          <nav class="cover-navigation navigation--social">
  <ul class="navigation">

  <!-- Weibo-->
  
  <li class="navigation__item">
    <a href="http://weibo.com/1929625262/profile?rightmod=1&amp;wvr=6&amp;mod=personinfo&amp;is_all=1" title="我的微博" target="_blank">
      <i class='social fa fa-weibo'></i>
      <span class="label">Weibo</span>
    </a>
  </li> 


  <!-- Github -->
  
  <li class="navigation__item">
    <a href="https://github.com/knightsj" title="查看我的GitHub主页" target="_blank">
      <i class='social fa fa-github'></i>
      <span class="label">Github</span>
    </a>
  </li>


<!-- Stack Overflow -->
        

  <!-- Google Plus -->
  

<!-- Facebook -->

  
<!-- Twitter -->

  

  <li class="navigation__item">
    <a href="/atom.xml" title="RSS" target="_blank">
      <i class='social fa fa-rss'></i>
      <span class="label">RSS</span>
    </a>
  </li>



  </ul>
</nav>

          </div>
        </div>

      </div>

    </div>

    <div class="panel-cover--overlay cover-purple"></div>
  </div>
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner">
            <article class="post-container post-container--single">

  <header class="post-header">
    <div class="post-meta">
      <time datetime="2017-01-11T07:27:10.000Z" class="post-list__meta--date date">2017-01-11</time> &#8226; <span class="post-meta__tags tags">于&nbsp;
  <a class="tag-link" href="/tags/Objective-C/">Objective-C</a>, <a class="tag-link" href="/tags/iOS/">iOS</a>
 </span>
      <span class="page-pv">
      &nbsp;阅读&nbsp;<span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span>
      </span> 
   
    </div>
    <h1 class="post-title">斯坦福大学iOS开发公开课总结（十四 十五）：CoreLocation，MapKit，在地图上标识Flickr摄影师的作品</h1>
  </header>

  <section class="post">
    <p>本总结将第十四和十五课放在了一起，原因有二：第一是略去了ipad开发Demo的部分（因为笔者木有ipad，无法进行调试）。第二是两节课都讲解了关于地图框架的相关知识，故将二者放在一起总结。</p>
<p>在本篇总结的最后，会给大家讲解在地图上显示Flickr上摄影师的照片作品。</p>
<h1 id="Network-Activity-Indicator"><a href="#Network-Activity-Indicator" class="headerlink" title="Network Activity Indicator"></a>Network Activity Indicator</h1><hr>
<p>顾名思义，该控件叫做网络活动指示器。当app有网络活动时，可以让状态栏左边的小圆圈滚动用来提示用户当前的网络状态。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">@property(nonatomic,getter=isNetworkActivityIndicatorVisible) BOOL networkActivityIndicatorVisible;</div></pre></td></tr></table></figure>
<p>如果设定为YES，状态栏上的小转轮就会转，反之亦然。</p>
<blockquote>
<p>注意：应用中的所有线程都可使用这个转轮，我们需要通过各种方法来向用户准确显示转轮的状态。</p>
</blockquote>
<h1 id="Core-Location"><a href="#Core-Location" class="headerlink" title="Core Location"></a>Core Location</h1><hr>
<p>通过该框架的基本类：<code>CLLocation</code>，我们能获得设备处于地球上的位置信息。</p>
<h2 id="Core-Location几个重要的属性："><a href="#Core-Location几个重要的属性：" class="headerlink" title="Core Location几个重要的属性："></a>Core Location几个重要的属性：</h2><h4 id="1-坐标属性"><a href="#1-坐标属性" class="headerlink" title="1. 坐标属性"></a>1. 坐标属性</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">typedef struct &#123;</div><div class="line">CLLocationDegrees latitude;    //double value</div><div class="line">CLLocationDegrees longitude;   //double value</div><div class="line">&#125; CLLocationCoordinate2D;</div></pre></td></tr></table></figure>
<h4 id="2-高度"><a href="#2-高度" class="headerlink" title="2. 高度"></a>2. 高度</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">@property(readonly, nonatomic) CLLocationDistance altitude; //单位是米</div></pre></td></tr></table></figure>
<h4 id="3-变化精度："><a href="#3-变化精度：" class="headerlink" title="3. 变化精度："></a>3. 变化精度：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">@property(readonly, nonatomic) CLLocationAccuracy horizontalAccuracy;//水平精度</div><div class="line">@property(readonly, nonatomic) CLLocationAccuracy verticalAccuracy;//高度精度</div></pre></td></tr></table></figure>
<p>如何获得CLLocation？<br>通过实例化<code>CLLocationManager</code>类，让其告诉它的代理当前设备所处的位置。<br>下面来介绍一下<code>CLLocationManager</code>:</p>
<h1 id="CLLocationManager"><a href="#CLLocationManager" class="headerlink" title="CLLocationManager"></a>CLLocationManager</h1><hr>
<h2 id="CLLocationManager的工作步骤："><a href="#CLLocationManager的工作步骤：" class="headerlink" title="CLLocationManager的工作步骤："></a>CLLocationManager的工作步骤：</h2><p>1.查看硬件是否支持位置更新。<br>2.实例化<code>CLLocationManager</code>让其告诉它的代理当前的位置。<br>3.设置位置更新的类型(精度)。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">@property(assign, nonatomic) CLLocationAccuracy desiredAccuracy; //期望的经度</div><div class="line">@property(assign, nonatomic) CLLocationDistance distanceFilter;  //更新到该距离之内不要告诉我更新了多少</div></pre></td></tr></table></figure>
<p>4.开始位置监控。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (void)startUpdatingLocation;//开始更新位置</div><div class="line">- (void)stopUpdatingLocation;//停止位置更新</div><div class="line">- (void)locationManager:(CLLocationManager *)manager didUpdateLocations:(NSArray&lt;CLLocation *&gt; *)locations;//位置更新的代理方法</div><div class="line">- (void)locationManager:(CLLocationManager *)manager didFailWithError:(NSError *)error;//更新失败</div></pre></td></tr></table></figure>
<h2 id="位置监控的类型："><a href="#位置监控的类型：" class="headerlink" title="位置监控的类型："></a>位置监控的类型：</h2><h4 id="1-基于精度的监控"><a href="#1-基于精度的监控" class="headerlink" title="1. 基于精度的监控"></a>1. 基于精度的监控</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">extern const CLLocationAccuracy kCLLocationAccuracyBestForNavigation; //最精确，但是非常耗能</div><div class="line">extern const CLLocationAccuracy kCLLocationAccuracyBest;</div><div class="line">extern const CLLocationAccuracy kCLLocationAccuracyNearestTenMeters;</div><div class="line">extern const CLLocationAccuracy kCLLocationAccuracyHundredMeters;</div><div class="line">extern const CLLocationAccuracy kCLLocationAccuracyKilometer;</div><div class="line">extern const CLLocationAccuracy kCLLocationAccuracyThreeKilometers;</div></pre></td></tr></table></figure>
<blockquote>
<p>注意：精度越高，耗电量越大</p>
</blockquote>
<h4 id="2-位置发生重大变化时更新。"><a href="#2-位置发生重大变化时更新。" class="headerlink" title="2. 位置发生重大变化时更新。"></a>2. 位置发生重大变化时更新。</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">- (void)startMonitoringSignificantLocationChanges;</div><div class="line">- (void)stopMonitoringSignificantLocationChanges ;</div></pre></td></tr></table></figure>
<p>该方法在前台和后台都能监控位置的变化，甚至关掉app后，也可以启动应用告诉用户位置更新:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions &#123;</div><div class="line">    //如果``launchOptions``存在``UIApplicationLaunchOptionsLocationKey``，说明程序启动的原因是因为位置发生了重大变化</div><div class="line">    return YES;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="3-进入某个区域更新。"><a href="#3-进入某个区域更新。" class="headerlink" title="3. 进入某个区域更新。"></a>3. 进入某个区域更新。</h4><p>3.1设定一个圆形的区域，经过该区域的时候会更新</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">- (void)startMonitoringForRegion:(CLRegion *)region;</div><div class="line">- (void)requestStateForRegion:(CLRegion *)region;</div></pre></td></tr></table></figure>
<p>3.2 通过一个信标来监控</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">@property (readonly, nonatomic) CLLocationDistance maximumRegionMonitoringDistance;//设置最大监控距离</div><div class="line"></div><div class="line">- (void)startRangingBeaconsInRegion:(CLBeaconRegion *)region;//设置信标</div></pre></td></tr></table></figure>
<h4 id="4-监控前进的方向"><a href="#4-监控前进的方向" class="headerlink" title="4. 监控前进的方向"></a>4. 监控前进的方向</h4><h1 id="MapKit"><a href="#MapKit" class="headerlink" title="MapKit"></a>MapKit</h1><hr>
<p>MapKit是用于显示地图的框架，它通过<code>MKMapView</code>来显示地图。<br>我们来看一下该框架中几个比较重要的元素：</p>
<h2 id="1-MKMapView"><a href="#1-MKMapView" class="headerlink" title="1. MKMapView"></a>1. MKMapView</h2><p>MKMapView就是用来显示地图的View。</p>
<p>MKMapView的属性：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">@property (nonatomic) MKMapType mapType;// MKMapTypeStandard : 标准；MKMapTypeSatellite:卫星；MKMapTypeHybrid：叠加</div><div class="line">@property (nonatomic) BOOL showsUserLocation; //显示用户的地点</div><div class="line">@property (nonatomic, readonly, getter=isUserLocationVisible) BOOL userLocationVisible;</div><div class="line">//用户坐标是否可见</div><div class="line">@property (nonatomic, getter=isZoomEnabled) BOOL zoomEnabled; //是否可放大缩小</div><div class="line">@property (nonatomic, getter=isRotateEnabled) BOOL rotateEnabled; //是否可旋转</div><div class="line">@property (nonatomic, getter=isPitchEnabled) BOOL pitchEnabled; //3D效果</div></pre></td></tr></table></figure></p>
<h2 id="2-MKAnnotationView"><a href="#2-MKAnnotationView" class="headerlink" title="2. MKAnnotationView"></a>2. MKAnnotationView</h2><p>在<code>MKMapView</code>视图里，可以显示用于标注具体位置的“大头针” ，它是MapKit框架里的<code>AnnotationView</code>。</p>
<p>MKAnnotationView的属性：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">@property (nonatomic, strong, nullable) id &lt;MKAnnotation&gt; annotation;</div><div class="line">@property (nonatomic, strong, nullable) UIImage *image;//大头针的图像</div><div class="line">@property (strong, nonatomic, nullable) UIView *leftCalloutAccessoryView;//左附属对话框</div><div class="line">@property (strong, nonatomic, nullable) UIView *rightCalloutAccessoryView;//右附属对话框</div><div class="line">@property (nonatomic, getter=isDraggable) BOOL draggable //是否可拖动</div></pre></td></tr></table></figure></p>
<p>大头针被点击时调用的方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (void)mapView:(MKMapView *)mapView didSelectAnnotationView:(MKAnnotationView *)view</div></pre></td></tr></table></figure></p>
<h2 id="3-id"><a href="#3-id" class="headerlink" title="3. id"></a>3. id<mkannotation></mkannotation></h2><p>AnnotationView的数据源就是：id<mkannotation>，任何遵从该协议的对象都可以成为AnnotationView的数据源，也就是说，任何遵守    <code>MKAnootation</code>协议的对象你都可以将其放入地图中。</mkannotation></p>
<p>我们先看一下在MKMapView里的关于MKAnnotation的属性：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">@property (nonatomic, readonly) NSArray&lt;id&lt;MKAnnotation&gt;&gt; *annotations;//包含MapView所显示的所有Annotaion</div></pre></td></tr></table></figure></p>
<p>注意：annotations是只读的数组，只能添加或者删除。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (void)addAnnotation:(id &lt;MKAnnotation&gt;)annotation;</div><div class="line">- (void)addAnnotations:(NSArray&lt;id&lt;MKAnnotation&gt;&gt; *)annotations;</div><div class="line">- (void)removeAnnotation:(id &lt;MKAnnotation&gt;)annotation;</div><div class="line">- (void)removeAnnotations:(NSArray&lt;id&lt;MKAnnotation&gt;&gt; *)annotations;</div></pre></td></tr></table></figure>
<p>MKAnnotation协议的方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">@protocol MKAnnotation &lt;NSObject&gt;</div><div class="line">@property (nonatomic, readonly) CLLocationCoordinate2D coordinate; //坐标</div><div class="line"></div><div class="line">@optional</div><div class="line">@property (nonatomic, readonly, copy, nullable) NSString *title;//标题</div><div class="line">@property (nonatomic, readonly, copy, nullable) NSString *subtitle;//副标题</div><div class="line"></div><div class="line">- (void)setCoordinate:(CLLocationCoordinate2D)newCoordinate ;//设置坐标</div></pre></td></tr></table></figure>
<p>那么二者是如何关联的呢？<br>通过MKMapView的代理方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (MKAnnotationView *)mapView:(MKMapView *)mapView viewForAnnotation:(id&lt;MKAnnotation&gt;)annotation</div><div class="line">&#123;</div><div class="line">    //提供一个 annotation，返回一个 MKAnnotationView</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="4-Callout-对话框"><a href="#4-Callout-对话框" class="headerlink" title="4. Callout(对话框)"></a>4. Callout(对话框)</h2><p>点击大头针（MKAnnotationView），会出现一个白底的对话框，它被叫做<code>callout</code>,可以设置它的主标题和副标题。另外还有左右附属实图，它们可以显示图片或者箭头，也可被点击。
﻿</p>
<h1 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h1><hr>
<h2 id="Demo需求："><a href="#Demo需求：" class="headerlink" title="Demo需求："></a>Demo需求：</h2><ul>
<li>显示从flickr抓取的摄影师列表。</li>
<li>点击列表中的一项，打开地图，在当前摄影师所照照片的地点显示大头针。</li>
<li>点击其中的一个大头针，显示照片详情：缩略图和名称。</li>
<li>点击箭头按钮，滑入显示照片的页面，显示原始照片。</li>
</ul>
<h2 id="Demo效果图："><a href="#Demo效果图：" class="headerlink" title="Demo效果图："></a>Demo效果图：</h2><p><img src="http://upload-images.jianshu.io/upload_images/859001-269dd622430d4972.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="在地图显示照片拍摄位置"></p>
<h2 id="重要代码段和知识点："><a href="#重要代码段和知识点：" class="headerlink" title="重要代码段和知识点："></a>重要代码段和知识点：</h2><h4 id="1-更改Core-Data模型"><a href="#1-更改Core-Data模型" class="headerlink" title="1. 更改Core Data模型"></a>1. 更改Core Data模型</h4><p>在上一节课的基础上，我们需要在模型里的<code>Photo</code>实体添加经度和纬度的属性，还有大头针缩略图的URL属性。<br>在更新属性后，一定要重新生成对应该实体的类文件，并且要将原app删除，因为数据库前后是不兼容的。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/859001-0bf538fa1a08fe3d.gif?imageMogr2/auto-orient/strip" alt="更新模型"></p>
<h4 id="2-新建PhotosByPhotographerMapViewController-h，用来显示MKMapView"><a href="#2-新建PhotosByPhotographerMapViewController-h，用来显示MKMapView" class="headerlink" title="2. 新建PhotosByPhotographerMapViewController.h，用来显示MKMapView"></a>2. 新建PhotosByPhotographerMapViewController.h，用来显示<code>MKMapView</code></h4><p>因为要在地图上显示摄影师所照照片的位置，因此，该类的数据源来自摄影师模型：<code>Photographer</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#import &lt;UIKit/UIKit.h&gt;</div><div class="line">#import &quot;Photographer.h&quot;</div><div class="line">@interface PhotosByPhotographerMapViewController : UIViewController</div><div class="line">@property (nonatomic, strong) Photographer *photographer;//公共API：摄影师</div><div class="line">@end</div></pre></td></tr></table></figure>
<p>``</p>
<p>#import “PhotosByPhotographerMapViewController.h”</p>
<p>#import <mapkit mapkit.h=""></mapkit></p>
<p>@interface PhotosByPhotographerMapViewController ()<mkmapviewdelegate><br>@property (strong, nonatomic) IBOutlet MKMapView <em>mapView;//地图view<br>@property (nonatomic,strong) NSArray </em>photosByPhotographer;//装入摄影师拥有的照片的数组<br>@end</mkmapviewdelegate></p>
<p>@implementation PhotosByPhotographerMapViewController<br>@end<br>``</p>
<h4 id="3-导入Mapkit的framework"><a href="#3-导入Mapkit的framework" class="headerlink" title="3. 导入Mapkit的framework"></a>3. 导入Mapkit的framework</h4><p>需要注意的是，除了要在类文件引用<code>&lt;MapKit/MapKit.h&gt;</code>框架以外，还要手动向项目中添加该框架：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/859001-8fb04dfbac7bbdd7.gif?imageMogr2/auto-orient/strip" alt="手动添加MapKit框架.gif"></p>
<h4 id="4-更新photographer和mapView后更新annotation："><a href="#4-更新photographer和mapView后更新annotation：" class="headerlink" title="4. 更新photographer和mapView后更新annotation："></a>4. 更新photographer和mapView后更新annotation：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">- (void)setMapView:(MKMapView *)mapView</div><div class="line">&#123;</div><div class="line">    _mapView = mapView;</div><div class="line"></div><div class="line">    //设置代理</div><div class="line">    self.mapView.delegate = self;</div><div class="line"></div><div class="line">    //更新</div><div class="line">    [self updateMapViewAnnotations];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)setPhotographer:(Photographer *)photographer</div><div class="line">&#123;</div><div class="line">    _photographer = photographer;</div><div class="line">    //导航栏标题</div><div class="line">    self.title = photographer.name;</div><div class="line">    //准备更新数组，要事先设置其为nil，否则不会生成新的</div><div class="line">    self.photosByPhotographer = nil;</div><div class="line">    [self updateMapViewAnnotations];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)updateMapViewAnnotations</div><div class="line">&#123;</div><div class="line">    [self.mapView removeAnnotations:self.mapView.annotations];</div><div class="line">    [self.mapView addAnnotations:self.photosByPhotographer];</div><div class="line">    [self.mapView showAnnotations:self.photosByPhotographer animated:YES];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="5-自定义点击大头针后显示的view"><a href="#5-自定义点击大头针后显示的view" class="headerlink" title="5. 自定义点击大头针后显示的view"></a>5. 自定义点击大头针后显示的view</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">- (MKAnnotationView *)mapView:(MKMapView *)mapView viewForAnnotation:(id&lt;MKAnnotation&gt;)annotation</div><div class="line">&#123;</div><div class="line"></div><div class="line">    //类似UITableviewCell的复用</div><div class="line">    static NSString *reuseId = @&quot;PhotosByPhotographerMapViewController&quot;;    </div><div class="line"></div><div class="line">    MKPinAnnotationView *view = (MKPinAnnotationView*)[mapView dequeueReusableAnnotationViewWithIdentifier:reuseId];    </div><div class="line"></div><div class="line">    if (!view) &#123;</div><div class="line">        view = [[MKPinAnnotationView alloc] initWithAnnotation:annotation reuseIdentifier:reuseId];</div><div class="line">       //是否显示callout</div><div class="line">        view.canShowCallout = YES;</div><div class="line">        //设置左部分的callout：UIImageView</div><div class="line">        UIImageView *imageView = [[UIImageView alloc] initWithFrame:CGRectMake(0, 0, 46, 46)];</div><div class="line">        view.leftCalloutAccessoryView = imageView;</div><div class="line">        //设置右部分的callout：UIButton</div><div class="line">        UIButton *disclosurebutton = [[UIButton alloc] init];</div><div class="line">        [disclosurebutton setBackgroundImage:[UIImage imageNamed:@&quot;disclosure&quot;] forState:UIControlStateNormal];</div><div class="line">        [disclosurebutton sizeToFit];</div><div class="line">        view.rightCalloutAccessoryView = disclosurebutton;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    view.annotation = annotation;</div><div class="line">    return view;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="6-点击大头针，更新callout左侧显示的缩略图"><a href="#6-点击大头针，更新callout左侧显示的缩略图" class="headerlink" title="6. 点击大头针，更新callout左侧显示的缩略图"></a>6. 点击大头针，更新callout左侧显示的缩略图</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/**</div><div class="line"> *  点击大头针view</div><div class="line"> *</div><div class="line"> *  @param mapView 大头针所属的mapView</div><div class="line"> *  @param view    大头针view</div><div class="line"> */</div><div class="line">- (void)mapView:(MKMapView *)mapView didSelectAnnotationView:(MKAnnotationView *)view</div><div class="line">&#123;</div><div class="line">    [self updateLeftCalloutAccessoryViewInAnnotationView:view];</div><div class="line">&#125;</div><div class="line"></div><div class="line">/**</div><div class="line"> *  更新callout里的图片（在左侧）</div><div class="line"> *</div><div class="line"> *  @param annotationView 当前被点击的大头针view</div><div class="line"> */</div><div class="line">- (void)updateLeftCalloutAccessoryViewInAnnotationView:(MKAnnotationView *)annotationView</div><div class="line">&#123;</div><div class="line">    UIImageView *imageView = nil;</div><div class="line">    if ([annotationView.leftCalloutAccessoryView isKindOfClass:[UIImageView class]]) &#123;</div><div class="line">        imageView = (UIImageView *)annotationView.leftCalloutAccessoryView;</div><div class="line">    &#125;</div><div class="line">    if (imageView) &#123;</div><div class="line">        Photo *photo = nil;</div><div class="line">        if ([annotationView.annotation isKindOfClass:[Photo class]]) &#123;</div><div class="line">            photo = (Photo *)annotationView.annotation;</div><div class="line">        &#125;</div><div class="line">        if (photo) &#123;</div><div class="line">            NSString *urlString = photo.thumbnailURL;</div><div class="line">            imageView.image = [UIImage imageWithData:[NSData dataWithContentsOfURL:[NSURL URLWithString:urlString]]];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>注意：显示图片的代码：<code>imageView.image = [UIImage imageWithData:[NSData dataWithContentsOfURL:[NSURL URLWithString:urlString]]];</code>方法会阻塞主线程，实际操作中应该放在子线程中执行。详情请参考笔者另一篇讲解关于多线程的博客：<a href="http://www.jianshu.com/p/6e74f5438f2c" target="_blank" rel="external">最浅显易懂的iOS多线程技术 - GCD的教程</a>。</p>
</blockquote>
<h4 id="7-点击callout，在下一页面显示原图"><a href="#7-点击callout，在下一页面显示原图" class="headerlink" title="7. 点击callout，在下一页面显示原图"></a>7. 点击callout，在下一页面显示原图</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> *  点击callout实行跳转</div><div class="line"> *</div><div class="line"> *  @param mapView 当前的mapView</div><div class="line"> *  @param view    当前callout所属的AnnotationView</div><div class="line"> *  @param control callout内部被点击的控件</div><div class="line"> */</div><div class="line">- (void)mapView:(MKMapView *)mapView annotationView:(MKAnnotationView *)view calloutAccessoryControlTapped:(UIControl *)control</div><div class="line">&#123;</div><div class="line">    [self performSegueWithIdentifier:@&quot;Show Photo&quot; sender:view];</div><div class="line">&#125;</div><div class="line"></div><div class="line">/**</div><div class="line"> *  调转执行前的代码</div><div class="line"> *</div><div class="line"> *  @param segue  连接前后两个控制器的segue</div><div class="line"> *  @param sender 被点击的AnnotaionView</div><div class="line"> */</div><div class="line">- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender</div><div class="line">&#123;</div><div class="line"> </div><div class="line">    if ([sender isKindOfClass:[MKAnnotationView class]]) &#123;</div><div class="line">        [self prepareViewController:segue.destinationViewController</div><div class="line">                           forSegue:segue.identifier</div><div class="line">                   toShowAnnotation:((MKAnnotationView *)sender).annotation];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/**</div><div class="line"> *  为目标控制器准备数据（图片的URL）</div><div class="line"> *</div><div class="line"> *  @param vc              目标控制器</div><div class="line"> *  @param segueIdentifier segue.identifier</div><div class="line"> *  @param annotation      被点击的AnnotaionView</div><div class="line"> */</div><div class="line">- (void)prepareViewController:(id)vc</div><div class="line">                     forSegue:(NSString *)segueIdentifier</div><div class="line">             toShowAnnotation:(id &lt;MKAnnotation&gt;)annotation</div><div class="line">&#123;</div><div class="line">    Photo *photo = nil;</div><div class="line">    if ([annotation isKindOfClass:[Photo class]]) &#123;</div><div class="line">        photo = (Photo *)annotation;</div><div class="line">    &#125;</div><div class="line">    if (photo) &#123;</div><div class="line">        if (![segueIdentifier length] || [segueIdentifier isEqualToString:@&quot;Show Photo&quot;]) &#123;</div><div class="line">            if ([vc isKindOfClass:[ImageViewController class]]) &#123;</div><div class="line">                ImageViewController *ivc = (ImageViewController *)vc;</div><div class="line">                ivc.imageURL = [NSURL URLWithString:photo.imageURL];</div><div class="line">                ivc.title = photo.title;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>注意：这里的<code>ivc.imageURL = [NSURL URLWithString:photo.imageURL];</code>代码同样会阻塞主线程，实际操作中应该放在子线程来做！</p>
<p>而且,本demo的图片地址应该都是在墙外的，所以最好先让电脑翻墙，然后在模拟器上运行比较好。</p>
</blockquote>
<h1 id="最后的话"><a href="#最后的话" class="headerlink" title="最后的话"></a>最后的话</h1><hr>
<p>如果哪位小伙伴想拿到本文Demo的代码请不要客气，可以进入我的<a href="https://github.com/Shijie0111/Stanford_iOS_Lecture_DemoBundle">GitHub</a>下载哦~    这一系列到现在为止的所有Demo都在里面，分为英文注释版本和中文注释版本两种。</p>
<p>十分欢迎给笔者的代码和文笔抛出宝贵的意见和建议~</p>
<p>本文为笔者原创，如需转载，请事先与笔者交涉~</p>

  </section>

</article>
<section class="read-more">
           
    
               
            <div class="read-more-item">
                <span class="read-more-item-dim">最近的文章</span>
                <h2 class="post-list__post-title post-title"><a href="/2017/01/11/斯坦福大学iOS开发公开课总结（十六）：模态视图，UITextField,UImagePickerController，在Flickr添加摄影师照片Demo/" title="斯坦福大学iOS开发公开课总结（十六）：模态视图，UITextField，UImagePickerController，在Flickr添加摄影师照片Demo">斯坦福大学iOS开发公开课总结（十六）：模态视图，UITextField，UImagePickerController，在Flickr添加摄影师照片Demo</a></h2>
                <p class="excerpt">
                
                本节课讲解了模态视图，文本框，UImagePickerController的相关知识，并延续了上一节课的Demo，添加了照相并存储照片的功能。
模态视图
模态视图不同于左右滑入的视图，它是从下往上，覆盖整个屏幕的视图。每次滑入都会重新新建一个控制器。通常用于修改信息等操作。
显示模态视图：
1  [
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2017-01-11T07:28:46.000Z" class="post-list__meta--date date">2017-01-11</time> &#8226; <span class="post-list__meta--tags tags">于&nbsp;
  <a class="tag-link" href="/tags/Objective-C/">Objective-C</a>, <a class="tag-link" href="/tags/iOS/">iOS</a>
</span><a class="btn-border-small" href="/2017/01/11/斯坦福大学iOS开发公开课总结（十六）：模态视图，UITextField,UImagePickerController，在Flickr添加摄影师照片Demo/">继续阅读</a></div>
                           
            </div>
        
        
               
            <div class="read-more-item">
                <span class="read-more-item-dim">更早的文章</span>
                <h2 class="post-list__post-title post-title"><a href="/2017/01/11/斯坦福大学iOS开发公开课总结（十二 十三）：CoreData，表格视图，Flickr摄影师资料列表/" title="斯坦福大学iOS开发公开课总结（十二 十三）：CoreData,表格视图，Flickr摄影师资料列表Demo">斯坦福大学iOS开发公开课总结（十二 十三）：CoreData,表格视图，Flickr摄影师资料列表Demo</a></h2>
                <p class="excerpt">
                
                第十二课和第十三课都介绍了CoreData的知识，并在十三课的中段通过一个Demo来具体实现了CoreData的操作。
笔者之前从未接触过Core Data的相关知识，因此学期这两节课比较吃力，这一篇总结还是有很多需要改进的地方，以后随着对Core Data认识的深入和对这两节课的反复咀嚼，会不断更
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2017-01-11T07:21:28.000Z" class="post-list__meta--date date">2017-01-11</time> &#8226; <span class="post-list__meta--tags tags">于&nbsp;
  <a class="tag-link" href="/tags/Objective-C/">Objective-C</a>, <a class="tag-link" href="/tags/iOS/">iOS</a>
</span><a class="btn-border-small" href="/2017/01/11/斯坦福大学iOS开发公开课总结（十二 十三）：CoreData，表格视图，Flickr摄影师资料列表/">继续阅读</a></div>
                       
            </div>
        
     
   
   
  
</section>

            
            <footer class="footer">
    <span class="footer__copyright">
        本站点采用 <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>
    </span>
    <span class="footer__copyright">
        基于 <a href="http://hexo.io">Hexo</a> 搭建，感谢 <a href="https://pages.github.com/">GitHub Pages</a> 提供免费的托管服务
    </span>
    <span class="footer__copyright">
        &copy; 2017 - 本站由 <a href="/">@Monniya</a> 创建,
        使用 <a href="https://github.com/monniya/hexo-theme-new-vno ">hexo-theme-new-vno</a> 主题,
        修改自 <a href="https://github.com/lenbo-ma/hexo-theme-vno" target="_blank">Vno</a>, 原创出自<a href="http://github.com/onevcat/vno" target="_blank">onevcat</a>
    </span>
</footer>
        </div>
    </div>

    

     
<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-78918255-1', 'auto');
	ga('send', 'pageview');
</script>

    
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?9cdad07c755fa23f6aced510c6760e87";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
    </script>



    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
    
    </script>
    
</body>
</html>

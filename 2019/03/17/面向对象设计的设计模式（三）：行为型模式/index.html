<!doctype html>




<html class="theme-next pisces" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css">


  <meta name="keywords" content="iOS,Objectice-C,Object-Oriented,Design Pattern,">





  <link rel="alternate" href="/atom.xml" title="J_Knight_" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0">






<meta name="description" content="本篇是面向对象设计系列文章的第四篇，讲解的是设计模式中的7个比较常见的行为型模式（按照本文讲解顺序排列）：  模板方法模式 策略模式 责任链模式 状态模式 命令模式 观察者模式 中介者模式">
<meta name="keywords" content="iOS,Objectice-C,Object-Oriented,Design Pattern">
<meta property="og:type" content="article">
<meta property="og:title" content="面向对象设计的设计模式（三）：行为型模式（附 Demo 及 UML 类图）">
<meta property="og:url" content="https://github.com/knightsj/knightsj.github.io/2019/03/17/面向对象设计的设计模式（三）：行为型模式/index.html">
<meta property="og:site_name" content="J_Knight_">
<meta property="og:description" content="本篇是面向对象设计系列文章的第四篇，讲解的是设计模式中的7个比较常见的行为型模式（按照本文讲解顺序排列）：  模板方法模式 策略模式 责任链模式 状态模式 命令模式 观察者模式 中介者模式">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-creation/odd_dp2_banner.png">
<meta property="og:image" content="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/tp_1.png">
<meta property="og:image" content="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/tp_2.png">
<meta property="og:image" content="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/stap_1.png">
<meta property="og:image" content="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/stap_2.png">
<meta property="og:image" content="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/crp_1.png">
<meta property="og:image" content="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/cp_2.png">
<meta property="og:image" content="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/cp_3.png">
<meta property="og:image" content="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/sp_1.png">
<meta property="og:image" content="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/sp_2.png">
<meta property="og:image" content="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/cd_1.png">
<meta property="og:image" content="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/cd_2.png">
<meta property="og:image" content="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/op_1.png">
<meta property="og:image" content="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/op_2.png">
<meta property="og:image" content="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/mp_1.png">
<meta property="og:image" content="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/mp_2.png">
<meta property="og:updated_time" content="2019-03-17T15:16:52.159Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="面向对象设计的设计模式（三）：行为型模式（附 Demo 及 UML 类图）">
<meta name="twitter:description" content="本篇是面向对象设计系列文章的第四篇，讲解的是设计模式中的7个比较常见的行为型模式（按照本文讲解顺序排列）：  模板方法模式 策略模式 责任链模式 状态模式 命令模式 观察者模式 中介者模式">
<meta name="twitter:image" content="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-creation/odd_dp2_banner.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: false,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://github.com/knightsj/knightsj.github.io/2019/03/17/面向对象设计的设计模式（三）：行为型模式/">





  <title> 面向对象设计的设计模式（三）：行为型模式（附 Demo 及 UML 类图） | J_Knight_ </title>
</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  




<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?46e6f54887b680a685201da90f1b9384";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>









  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">J_Knight_</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">每天进步一点点</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://github.com/knightsj/knightsj.github.io/2019/03/17/面向对象设计的设计模式（三）：行为型模式/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="J_Knight_">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/blog-config/jknight_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="J_Knight_">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                面向对象设计的设计模式（三）：行为型模式（附 Demo 及 UML 类图）
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-17T15:04:41+08:00">
                2019-03-17
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Object-Oriented/" itemprop="url" rel="index">
                    <span itemprop="name">Object-Oriented</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  14,429 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  60 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-creation/odd_dp2_banner.png" alt=""></p>
<p>本篇是面向对象设计系列文章的第四篇，讲解的是设计模式中的7个比较常见的行为型模式（按照本文讲解顺序排列）：</p>
<ul>
<li>模板方法模式</li>
<li>策略模式</li>
<li>责任链模式</li>
<li>状态模式</li>
<li>命令模式</li>
<li>观察者模式</li>
<li>中介者模式</li>
</ul>
<a id="more"></a>
<h1 id="一-模板方法模式"><a href="#一-模板方法模式" class="headerlink" title="一. 模板方法模式"></a>一. 模板方法模式</h1><h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><blockquote>
<p>在模板模式（Template Method Pattern）中，定义一个操作中的算法的框架，而将一些步骤的执行延迟到子类中，使得子类可以在不改变算法的结构的前提下即可重新定义该算法的某些特定步骤。</p>
</blockquote>
<h2 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h2><p>通常一个算法需要几个执行步骤来实现，而有时我们需要定义几种执行步骤一致，但是却可能在某个步骤的实现略有差异的算法。也就是说我们既需要复用实现相同的步骤，也可以通过在某个步骤的不同实现来灵活扩展出更多不同的算法。</p>
<p>在这种场景下，我们可以使用模板方法模式：定义好一个算法的框架，在父类实现可以复用的算法步骤，而将需要扩展和修改其他步骤的任务推迟给子类进行。</p>
<p>现在我们清楚了模板方法模式的适用场景，下面看一下这个模式的成员和类图。</p>
<h2 id="成员与类图"><a href="#成员与类图" class="headerlink" title="成员与类图"></a>成员与类图</h2><h3 id="成员"><a href="#成员" class="headerlink" title="成员"></a>成员</h3><p>模板方法模式的成员除了客户端以外，只有两个成员：</p>
<ul>
<li>算法类（Algorithm）：<strong>算法类</strong>负责声明算法接口，算法步骤接口。并实现可复用的算法步骤接口，且将需要子类实现的接口暴露出来。</li>
<li>具体算法类（Concrete Algorithm）：<strong>具体算法类</strong>负责实现算法类声明的算法步骤接口。</li>
</ul>
<blockquote>
<p>有些参考资料定义这两个成员为<code>Abstract Class</code>和<code>Concrete Class</code>。</p>
</blockquote>
<p>下面通过类图来看一下命令模式各个成员之间的关系：</p>
<h3 id="模式类图"><a href="#模式类图" class="headerlink" title="模式类图"></a>模式类图</h3><p><img src="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/tp_1.png" alt="模板方法模式类图"></p>
<p>由上图可以看出，<code>Algorithm</code>的<code>excute</code>方法是算法接口，它在内部调用了三个步骤方法：<code>step1</code>,<code>step2</code>,<code>step3</code>。而<code>step2</code>是未暴露在外部的，因为这个步骤是需要各个子类复用的。因此<code>Algorithm</code>只将<code>step1</code>和<code>step3</code>暴露了出来以供子类来调用。</p>
<h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><h3 id="场景概述"><a href="#场景概述" class="headerlink" title="场景概述"></a>场景概述</h3><p>模拟一个制作三种热饮的场景：热美式咖啡，热拿铁，热茶。</p>
<h3 id="场景分析"><a href="#场景分析" class="headerlink" title="场景分析"></a>场景分析</h3><p>这三种热饮的制作步骤是一致的，都是三个步骤：</p>
<ul>
<li>步骤一：准备热水</li>
<li>步骤二：加入主成分</li>
<li>步骤三：加入辅助成分（也可以不加，看具体热饮的种类）</li>
</ul>
<p>虽然制作步骤是一致的，但是不同种类的热饮在每一步可能是不同的：咖啡和茶叶主成分是咖啡粉和茶叶；而辅助成分：美式咖啡和茶叶可以不添加，而拿铁还需添加牛奶。</p>
<p>而第一步是相同的：准备热水。</p>
<p>根据上面对模板方法模式的介绍，像这样算法步骤相同，算法步骤里的实现可能相同或不同的场景我们可以使用模板方法模式。下面我们看一下如何用代码来模拟该场景。</p>
<h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><p>首先我们创建算法类<code>HotDrink</code>：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== HotDrink.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HotDrink</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)makingProcess;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addMainMaterial;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addIngredients;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== HotDrink.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HotDrink</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)makingProcess&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@" ===== Begin to making %@ ===== "</span>, <span class="built_in">NSStringFromClass</span>([<span class="keyword">self</span> <span class="keyword">class</span>]));</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> boilWater];</span><br><span class="line">    [<span class="keyword">self</span> addMainMaterial];</span><br><span class="line">    [<span class="keyword">self</span> addIngredients];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)prepareHotWater&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"prepare hot water"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addMainMaterial&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"implemetation by subClasses"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addIngredients&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"implemetation by subClasses"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><code>HotDrink</code>向外部暴露了一个制作过程的接口<code>makingProcess</code>，这个接口内部调用了热饮的所有制作步骤方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)makingProcess&#123;</span><br><span class="line">         </span><br><span class="line">     <span class="comment">//准备热水     </span></span><br><span class="line">    [<span class="keyword">self</span> prepareHotWater];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//添加主成分</span></span><br><span class="line">    [<span class="keyword">self</span> addMainMaterial];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//添加辅助成分</span></span><br><span class="line">    [<span class="keyword">self</span> addIngredients];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>HotDrink</code>只向外暴露了<strong>这三个步骤中的两个</strong>需要子类按照自己方式实现的接口：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加主成分</span></span><br><span class="line">- (<span class="keyword">void</span>)addMainMaterial;</span><br><span class="line"></span><br><span class="line"><span class="comment">//添加辅助成分</span></span><br><span class="line">- (<span class="keyword">void</span>)addIngredients;</span><br></pre></td></tr></table></figure>
<p>因为热饮的第一步都是一致的（准备热水），所以第一步骤的接口没有暴露出来给子类实现，而是直接在当前类实现了，这也就是模板方法的一个可以复用代码的优点。</p>
<p>OK，我们现在创建好了算法类，那么根据上面的需求，我们接着创建三个具体算法类：</p>
<ul>
<li><code>HotDrinkTea</code> ： 热茶</li>
<li><code>HotDrinkLatte</code> ： 热拿铁</li>
<li><code>HotDrinkAmericano</code>： 热美式</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== HotDrinkTea.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HotDrinkTea</span> : <span class="title">HotDrink</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== HotDrinkTea.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HotDrinkTea</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addMainMaterial&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"add tea leaf"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addIngredients&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"add nothing"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>热茶在<code>addMainMaterial</code>步骤里面是添加了茶叶，而在<code>addIngredients</code>步骤没有做任何事情（这里先假定是纯的茶叶）。</p>
<p>类似地，我们看一下两种热咖啡的实现。首先是热拿铁<code>HotDrinkLatte</code>:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== HotDrinkLatte.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HotDrinkLatte</span> : <span class="title">HotDrink</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== HotDrinkLatte.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HotDrinkLatte</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addMainMaterial&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"add ground coffee"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addIngredients&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"add milk"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>热拿铁在<code>addMainMaterial</code>步骤里面是添加了咖啡粉，而在<code>addIngredients</code>步骤添加了牛奶。</p>
<p>下面再看一下热美式<code>HotDrinkAmericano</code>：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== HotDrinkAmericano.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HotDrinkAmericano</span> : <span class="title">HotDrink</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== HotDrinkAmericano.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HotDrinkAmericano</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addMainMaterial&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"add ground coffee"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addIngredients&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"add nothing"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>热美式在<code>addMainMaterial</code>步骤里面是添加了咖啡粉，而在<code>addIngredients</code>步骤没有做任何事，因为美式就是纯的咖啡，理论上除了水和咖啡不需要添加任何其他东西。</p>
<p>到现在三种热饮类创建好了，我们现在分别制作这三种热饮，并看一下日至输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">===== Begin to making HotDrinkTea =====</span><br><span class="line">prepare hot water</span><br><span class="line">add tea leaf</span><br><span class="line">add nothing</span><br><span class="line">===== Begin to making HotDrinkLatte =====</span><br><span class="line">prepare hot water</span><br><span class="line">add ground coffee</span><br><span class="line">add milk</span><br><span class="line">===== Begin to making HotDrinkAmericano =====</span><br><span class="line">prepare hot water</span><br><span class="line">add ground coffee</span><br><span class="line">add nothing</span><br></pre></td></tr></table></figure>
<p>上面的日至输出准确无误地反映了我们所定义的这三种热饮制作过程：</p>
<ul>
<li>热茶：准备热水 + 茶叶</li>
<li>热拿铁：准备热水 + 咖啡 + 牛奶</li>
<li>热美式：准备热水 + 咖啡</li>
</ul>
<p>下面看一下上面代码对应的类图。</p>
<h3 id="代码对应的类图"><a href="#代码对应的类图" class="headerlink" title="代码对应的类图"></a>代码对应的类图</h3><p><img src="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/tp_2.png" alt="模板方法模式代码示例类图"></p>
<h2 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h2><ul>
<li>复用性高：将相同的代码放在父类中，而不同的部分则由子类实现</li>
<li>扩展性高：可以通过创建不同的子类来扩展不同的算法</li>
<li>符合开闭原则：可变与不可变的部分分离，而且不同的可变部分（子类）也是相互分离的，所以符合了开闭原则</li>
</ul>
<h2 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h2><ul>
<li>导致类的个数增加：对于每一个算法实现都需要一个子类，如果实现过多的话会导致类的个数增加</li>
<li>由继承关系导致的缺点：如果父类需要增加或减少它的行为，则所有的子类都需要同步修改一次</li>
</ul>
<h2 id="iOS-SDK-和-JDK中的应用"><a href="#iOS-SDK-和-JDK中的应用" class="headerlink" title="iOS SDK 和 JDK中的应用"></a>iOS SDK 和 JDK中的应用</h2><ul>
<li>在 iOS SDK 中，我们可以重写 <code>UIView</code>的<code>drawRect:</code>方法可以自定义绘图，是模板方法模式的一种实践。</li>
<li>在JDK中，<code>java.lang.Runnable</code>是使用JDK的经典场景：<code>Runnable</code>接口可以作为抽象的命令，而实现了Runnable的线程即是具体的命令。</li>
</ul>
<h1 id="二-策略模式"><a href="#二-策略模式" class="headerlink" title="二. 策略模式"></a>二. 策略模式</h1><h2 id="定义-1"><a href="#定义-1" class="headerlink" title="定义"></a>定义</h2><blockquote>
<p>策略模式(Strategy Pattern)：定义一系列算法，将每一个算法封装起来，并让它们可以相互替换。</p>
</blockquote>
<h2 id="适用场景-1"><a href="#适用场景-1" class="headerlink" title="适用场景"></a>适用场景</h2><p>有时候在实现某一个功能的时可能会有多个方案：我们需要让系统可以动态灵活地更换方案；而且也能够让开发者方便地增加新的方案或删除旧的方案。</p>
<p>如果我们将所有的方案硬编码在同一个类中，那么在今后修改，添加，删除某个方案的时候就会改动原有类，这是违反开闭原则的。</p>
<p>其实我们可以定义一些独立的类来封装不同的解决方案，每一个类封装一个具体的方案，这些不同的方案就是我们所说的策略。而且我们可以用一个抽象的策略类来保证这些策略的一致性，这就是策略模式的设计方案。</p>
<p>现在我们清楚了策略模式的适用场景，下面看一下策略模式的成员和类图。</p>
<h2 id="成员与类图-1"><a href="#成员与类图-1" class="headerlink" title="成员与类图"></a>成员与类图</h2><h3 id="成员-1"><a href="#成员-1" class="headerlink" title="成员"></a>成员</h3><p>策略模式除了客户端之外共有三个成员：</p>
<ul>
<li>环境类（Context）：<strong>环境类</strong>内部持有一个具体策略类的实例，这个实例就是当前的策略，可以供客户端使用</li>
<li>抽象策略类（Strategy）：<strong>抽象策略类</strong>声明具体策略类需要实现的接口，这个接口同时也是提供给客户端调用的接口</li>
<li>具体策略类（Concrete Strategy）：<strong>具体策略类</strong>实现抽象策略类声明的接口，每个具体策略类都有自己独有的实现方式，即代表不同策略</li>
</ul>
<p>下面我们通过类图来看一下各个成员之间的关系。</p>
<h3 id="模式类图-1"><a href="#模式类图-1" class="headerlink" title="模式类图"></a>模式类图</h3><p><img src="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/stap_1.png" alt="策略模式类图"></p>
<h2 id="代码示例-1"><a href="#代码示例-1" class="headerlink" title="代码示例"></a>代码示例</h2><h3 id="场景概述-1"><a href="#场景概述-1" class="headerlink" title="场景概述"></a>场景概述</h3><p>模拟一个两个整数可以随意替换加减乘除算法的场景。</p>
<h3 id="场景分析-1"><a href="#场景分析-1" class="headerlink" title="场景分析"></a>场景分析</h3><p>在该场景中，传入的两个整数参数是不变的，但是对于这两个整数的具体操作可以灵活切换，那么我们可以使用策略模式：将每个操作（算法）封装起来，在需要替换的时候将<code>Context</code>类持有的具体策略实例更新即可。</p>
<h3 id="代码实现-1"><a href="#代码实现-1" class="headerlink" title="代码实现"></a>代码实现</h3><p>首先我们定义好抽象策略类和具体策略类：</p>
<p>因为是针对两个整数的操作，所以在抽象策略类中，我们只需定义一个传入两个整数的接口即可。</p>
<p>抽象策略类<code>TwoIntOperation</code>:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== TwoIntOperation.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TwoIntOperation</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">int</span>)operationOfInt1:(<span class="keyword">int</span>)int1 int2:(<span class="keyword">int</span>)int2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== TwoIntOperation.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span>  <span class="title">TwoIntOperation</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">int</span>)operationOfInt1:(<span class="keyword">int</span>)int1 int2:(<span class="keyword">int</span>)int2&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//implenting by sub classes;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>接着我们根据加减乘除四种运算，来分别定义四个具体策略类：</p>
<p>加法<code>TwoIntOperationAdd</code>：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== TwoIntOperationAdd.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TwoIntOperationAdd</span> : <span class="title">TwoIntOperation</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== TwoIntOperationAdd.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TwoIntOperationAdd</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">int</span>)operationOfInt1:(<span class="keyword">int</span>)int1 int2:(<span class="keyword">int</span>)int2&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"==== adding ===="</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> int1 + int2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>减法<code>TwoIntOperationSubstract</code>：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== TwoIntOperationSubstract.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TwoIntOperationSubstract</span> : <span class="title">TwoIntOperation</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== TwoIntOperationSubstract.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TwoIntOperationSubstract</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">int</span>)operationOfInt1:(<span class="keyword">int</span>)int1 int2:(<span class="keyword">int</span>)int2&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"==== Substract ===="</span>);</span><br><span class="line">    <span class="keyword">return</span> int1 - int2;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p>乘法<code>TwoIntOperationMultiply</code>:<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== TwoIntOperationMultiply.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TwoIntOperationMultiply</span> : <span class="title">TwoIntOperation</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== TwoIntOperationMultiply.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TwoIntOperationMultiply</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">int</span>)operationOfInt1:(<span class="keyword">int</span>)int1 int2:(<span class="keyword">int</span>)int2&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"==== multiply ===="</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> int1 * int2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p>除法<code>TwoIntOperationDivision</code>:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== TwoIntOperationDivision.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TwoIntOperationDivision</span> : <span class="title">TwoIntOperation</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== TwoIntOperationDivision.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TwoIntOperationDivision</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">int</span>)operationOfInt1:(<span class="keyword">int</span>)int1 int2:(<span class="keyword">int</span>)int2&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"==== division ===="</span>);</span><br><span class="line">    <span class="keyword">return</span> int1/int2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>现在关于算法的类都声明好了，我们最后声明一下 <code>Context</code> 类：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== Context.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Context</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithOperation: (TwoIntOperation *)operation;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setOperation:(TwoIntOperation *)operation;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">int</span>)excuteOperationOfInt1:(<span class="keyword">int</span>)int1 int2:(<span class="keyword">int</span>)int2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== Context.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Context</span></span></span><br><span class="line">&#123;</span><br><span class="line">    TwoIntOperation *_operation;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithOperation: (TwoIntOperation *)operation&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="comment">//injection from instane initialization</span></span><br><span class="line">        _operation = operation;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setOperation:(TwoIntOperation *)operation&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//injection from setting method</span></span><br><span class="line">    _operation = operation;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">int</span>)excuteOperationOfInt1:(<span class="keyword">int</span>)int1 int2:(<span class="keyword">int</span>)int2&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//return value by constract strategy instane</span></span><br><span class="line">    <span class="keyword">return</span> [_operation operationOfInt1:int1 int2:int2];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><code>Context</code>类在构造器（init方法）注入了一个具体策略实例并持有它，而且<code>Context</code>也提供了<code>set</code>方法，让外部注入进来具体策略类的实例。</p>
<p>而策略的具体执行是通过<code>Context</code>的接口<code>excuteOperationOfInt1:int2</code>。这个接口是提供给客户端调用的；而且在它的内部其实调用的是当前持有的策略实例的执行策略的方法。</p>
<p>所以如果想使用哪种策略，只要将具体策略的实例传入到<code>Context</code>实例即可。</p>
<p>现在所有的类都定义好了，下面我们看一下具体如何使用：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> int1 = <span class="number">6</span>;</span><br><span class="line"><span class="keyword">int</span> int2 = <span class="number">3</span>;</span><br><span class="line">    </span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"int1: %d    int2: %d"</span>,int1,int2);</span><br><span class="line">    </span><br><span class="line"><span class="comment">//Firstly, using add operation</span></span><br><span class="line">TwoIntOperationAdd *addOperation = [[TwoIntOperationAdd alloc] init];</span><br><span class="line">Context *ct = [[Context alloc] initWithOperation:addOperation];</span><br><span class="line"><span class="keyword">int</span> res1 = [ct excuteOperationOfInt1:int1 int2:int2];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"result of adding : %d"</span>,res1);</span><br><span class="line">    </span><br><span class="line"><span class="comment">//Changing to multiple operation</span></span><br><span class="line">TwoIntOperationMultiply *multiplyOperation = [[TwoIntOperationMultiply alloc] init];</span><br><span class="line">[ct setOperation:multiplyOperation];</span><br><span class="line"><span class="keyword">int</span> res2 = [ct excuteOperationOfInt1:int1 int2:int2];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"result of multiplying : %d"</span>,res2);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment">//Changing to substraction operation</span></span><br><span class="line">TwoIntOperationSubstract *subOperation = [[TwoIntOperationSubstract alloc] init];</span><br><span class="line">[ct setOperation:subOperation];</span><br><span class="line"><span class="keyword">int</span> res3 = [ct excuteOperationOfInt1:int1 int2:int2];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"result of substracting : %d"</span>,res3);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment">//Changing to division operation</span></span><br><span class="line">TwoIntOperationDivision *divisionOperation = [[TwoIntOperationDivision alloc] init];</span><br><span class="line">[ct setOperation:divisionOperation];</span><br><span class="line"><span class="keyword">int</span> res4 = [ct excuteOperationOfInt1:int1 int2:int2];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"result of dividing : %d"</span>,res4);</span><br></pre></td></tr></table></figure>
<p>看一下日至输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[13431:1238320] int1: 6    int2: 3</span><br><span class="line">[13431:1238320] ==== adding ====</span><br><span class="line">[13431:1238320] result of adding : 9</span><br><span class="line">[13431:1238320] ==== multiply ====</span><br><span class="line">[13431:1238320] result of multiplying : 18</span><br><span class="line">[13431:1238320] ==== Substract ====</span><br><span class="line">[13431:1238320] result of substracting : 3</span><br><span class="line">[13431:1238320] ==== division ====</span><br><span class="line">[13431:1238320] result dividing : 2</span><br></pre></td></tr></table></figure></p>
<p>在上面的例子中，首先我们要使用加法，所以 实例化了加法策略类并传入到了<code>Context</code>类的构造器中。</p>
<p>而后续的乘法，减法，除法的更换，则是分别将它们的策略实例传入到了<code>Context</code>的set方法中，并执行即可。</p>
<p>下面看一下上面代码对应的类图。</p>
<h3 id="代码对应的类图-1"><a href="#代码对应的类图-1" class="headerlink" title="代码对应的类图"></a>代码对应的类图</h3><p><img src="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/stap_2.png" alt="策略模式代码示例类图"></p>
<h2 id="优点-1"><a href="#优点-1" class="headerlink" title="优点"></a>优点</h2><ul>
<li>策略模式遵循开闭原则，用户可以在不修改原有系统的前提下选择和更换算法</li>
<li>避免使用多重条件判断</li>
<li>可以灵活地增加新的算法或行为</li>
<li>提高算法和策略的安全性：可以封装策略的具体实现，调用者只需要知道不同策略之间的区别就可以</li>
</ul>
<h2 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h2><ul>
<li>客户端必须知道当前所有的具体策略类，而且需要自行决定使用哪一个策略类</li>
<li>如果可选的方案过多，会导致策略类数量激增。</li>
</ul>
<h2 id="iOS-SDK-和-JDK中的应用-1"><a href="#iOS-SDK-和-JDK中的应用-1" class="headerlink" title="iOS SDK 和 JDK中的应用"></a>iOS SDK 和 JDK中的应用</h2><ul>
<li>JDK中的<code>Comparator</code>是策略模式的实现，可以使用不同的子类，也就是具体策略来解决不同的需求。</li>
</ul>
<h1 id="三-责任链模式"><a href="#三-责任链模式" class="headerlink" title="三. 责任链模式"></a>三. 责任链模式</h1><h2 id="定义-2"><a href="#定义-2" class="headerlink" title="定义"></a>定义</h2><blockquote>
<p>责任链模式（Chain of Responsibility Pattern）：为请求创建了一个接收者对象的链，每个接收者都包含对另一个接收者的引用。如果一个对象不能处理该请求，那么它会把相同的请求传给下一个接收者，依此类推。</p>
</blockquote>
<h2 id="适用场景-2"><a href="#适用场景-2" class="headerlink" title="适用场景"></a>适用场景</h2><p>在处理某个请求的时候，解决策略因条件不同而不同。这时，相对于使用<code>if-else</code>来区分不同的条件和对应的解决策略，我们可以使用责任链模式，将不同条件和对应的解决策略封装到一个类中，即不同的处理者。然后将这些处理者组成责任链，在当前处理者无法处理或不符合当前条件时，将请求传递给下一个处理者。</p>
<p>现在我们清楚了责任链模式的适用场景，下面看一下责任链模式的成员和类图。</p>
<h2 id="成员与类图-2"><a href="#成员与类图-2" class="headerlink" title="成员与类图"></a>成员与类图</h2><h3 id="成员-2"><a href="#成员-2" class="headerlink" title="成员"></a>成员</h3><p>责任链模式的结构比较简单，不包括客户端只有两个成员：</p>
<ul>
<li>处理者（Handler）：<strong>处理者</strong>定义处理请求的接口</li>
<li>具体处理者（Concrete Handler）: <strong>具体处理者</strong>实现处理者声明的接口，负责处理请求</li>
</ul>
<h3 id="模式类图-2"><a href="#模式类图-2" class="headerlink" title="模式类图"></a>模式类图</h3><p><img src="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/crp_1.png" alt="责任链模式类图"></p>
<h2 id="代码示例-2"><a href="#代码示例-2" class="headerlink" title="代码示例"></a>代码示例</h2><h3 id="场景概述-2"><a href="#场景概述-2" class="headerlink" title="场景概述"></a>场景概述</h3><p>模拟一个 ATM 取现金的场景：ATM机器有50，20，10面值的纸币，根据用户需要提取的现金金额来输出纸币张数最少的等价金额的纸币。</p>
<p>比如用户需要取130元，则ATM需要输出2张50面额的纸币，1张20面额的纸币，1张10面额的纸币；而不是6张20面额的纸币加1张10面额的纸币。</p>
<h3 id="场景分析-2"><a href="#场景分析-2" class="headerlink" title="场景分析"></a>场景分析</h3><p>显然，为了输出最少张数的纸币，ATM在计算的时候是从面额最大的纸币开始计算的。</p>
<p>如果不使用责任链模式，我们可能会写一个<code>do-while</code>循环，在循环里面再根据纸币的面额在做<code>if-else</code>判断，不断去尝试直到将面额除尽（没有余数）。但是如果未来面额的数值发生变化，或者添加新的面额的纸币的话，我们还需要更改判断条件或增加<code>if-else</code>语句，这显然违反了开闭原则。</p>
<p>但是如果使用责任链模式，我们将每个面值的纸币当做责任链中的一个处理者（节点，node），自成一类，单独做处理。然后将这些处理者按照顺序连接起来（50，20，10），按照顺序对用户输入的数值进行处理即可。</p>
<p>这样做的好处是，如果以后修改面值或添加一种新的面值，我们只需要修改其中某一个处理者或者新建一个处理者类，再重新插入到责任链的合适的位置即可。</p>
<p>下面我们看一下如何用代码来模拟该场景。</p>
<h3 id="代码实现-2"><a href="#代码实现-2" class="headerlink" title="代码实现"></a>代码实现</h3><p>首先创建抽象处理者<code>DispenseChainNode</code>:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== DispenseChainNode.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">DispenseChainNode</span> : <span class="title">NSObject</span> &lt;<span class="title">DispenseProtocol</span>&gt;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">@protected</span> DispenseChainNode *_nextChainUnit;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setNextChainUnit:(DispenseChainNode *)chainUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== DispenseChainNode.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">DispenseChainNode</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setNextChainNode:(DispenseChainNode *)chainNode&#123;</span><br><span class="line">    </span><br><span class="line">    _nextChainNode = chainNode;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)dispense:(<span class="keyword">int</span>)amount&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><code>DispenseChainNode</code>是责任链节点，也就是具体处理者的父类，它持有<code>DispenseChainNode</code>的实例，用来保存当前节点的下一个节点。这个下一个节点的实例是通过<code>setNextChainNode:</code>方法注入进来的<br>而且，<code>DispenseChainNode</code>遵循<code>&lt;DispenseProtocol&gt;</code>协议，这个协议只有一个方法，就是<code>dispense:</code>方法，每个节点都实现这个方法来对输入的金额做处理。（dispense 单词的意思是分配，分发）</li>
</ul>
</blockquote>
<p>现在我们根据需求，创建具体处理者，也就是针对50，20，10面额的具体处理者：</p>
<p>50面额的具体处理者：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== DispenseChainNodeFor50Yuan.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">DispenseChainNodeFor50Yuan</span> : <span class="title">DispenseChainNode</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== DispenseChainNodeFor50Yuan.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">DispenseChainNodeFor50Yuan</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)dispense:(<span class="keyword">int</span>)amount&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> unit = <span class="number">50</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (amount &gt;= unit) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">int</span> count = amount/unit;</span><br><span class="line">        <span class="keyword">int</span> remainder = amount % unit;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Dispensing %d of %d"</span>,count,unit);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (remainder != <span class="number">0</span>) &#123;</span><br><span class="line">            [_nextChainNode dispense:remainder];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        </span><br><span class="line">        [_nextChainNode dispense:amount];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p>20面额的具体处理者：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== DispenseChainNodeFor20Yuan.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">DispenseChainNodeFor20Yuan</span> : <span class="title">DispenseChainNode</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== DispenseChainNodeFor20Yuan.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">DispenseChainNodeFor20Yuan</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)dispense:(<span class="keyword">int</span>)amount&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> unit = <span class="number">20</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (amount &gt;= unit) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">int</span> count = amount/unit;</span><br><span class="line">        <span class="keyword">int</span> remainder = amount % unit;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Dispensing %d of %d"</span>,count,unit);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (remainder != <span class="number">0</span>) &#123;</span><br><span class="line">            [_nextChainNode dispense:remainder];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        </span><br><span class="line">        [_nextChainNode dispense:amount];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p>10面额的具体处理者：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== DispenseChainNodeFor10Yuan.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">DispenseChainNodeFor10Yuan</span> : <span class="title">DispenseChainNode</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== DispenseChainNodeFor10Yuan.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">DispenseChainNodeFor10Yuan</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)dispense:(<span class="keyword">int</span>)amount&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> unit = <span class="number">10</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (amount &gt;= unit) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">int</span> count = amount/unit;</span><br><span class="line">        <span class="keyword">int</span> remainder = amount % unit;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Dispensing %d of %d"</span>,count,unit);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (remainder != <span class="number">0</span>) &#123;</span><br><span class="line">            [_nextChainNode dispense:remainder];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        </span><br><span class="line">        [_nextChainNode dispense:amount];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p>上面三个具体处理者在<code>dispense:</code>方法的处理都是类似的：</p>
<p>首先查看当前值是否大于面额</p>
<ul>
<li>如果大于面额<ul>
<li>将当前值除以当前面额<ul>
<li>如果没有余数，则停止，不作处理</li>
<li>如果有余数，则继续将当前值传递给下一个具体处理者（责任链的下一个节点）</li>
</ul>
</li>
</ul>
</li>
<li>如果小于面额：将当前值传递给下一个具体处理者（责任链的下一个节点）</li>
</ul>
<p>现在我们创建好了三个具体处理者，我们再创建一个ATM类来把这些节点串起来：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== ATMDispenseChain.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ATMDispenseChain</span> : <span class="title">NSObject</span>&lt;<span class="title">DispenseProtocol</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== ATMDispenseChain.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ATMDispenseChain</span></span></span><br><span class="line">&#123;</span><br><span class="line">    DispenseChainNode *_chainNode;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">self</span>)&#123;</span><br><span class="line">        </span><br><span class="line">        DispenseChainNodeFor50Yuan *chainNode50 = [[DispenseChainNodeFor50Yuan alloc] init];</span><br><span class="line">        DispenseChainNodeFor20Yuan *chainNode20 = [[DispenseChainNodeFor20Yuan alloc] init]; </span><br><span class="line">        DispenseChainNodeFor10Yuan *chainNode10 = [[DispenseChainNodeFor10Yuan alloc] init];</span><br><span class="line">        </span><br><span class="line">         _chainNode = chainNode50;</span><br><span class="line">        [_chainNode setNextChainNode:chainNode20];</span><br><span class="line">        [chainNode20 setNextChainNode:chainNode10];</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)dispense:(<span class="keyword">int</span>)amount&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"=================================="</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"ATM start dispensing of amount:%d"</span>,amount);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (amount %<span class="number">10</span> != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Amount should be in multiple of 10"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [_chainNode dispense:amount];</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><code>ATMDispenseChain</code>这个类在初始化的时候就将三个具体处理者并按照50，20，10的顺序连接起来，并持有一个<code>DispenseChainNode</code>的指针指向当前的具体处理者（也就是责任链的第一个节点，面额50的具体处理者，因为面额的处理是从50开始的）。</p>
<p>OK，现在我们把三个具体处理者都封装好了，可以看一下如何使用：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ATMDispenseChain *atm = [[ATMDispenseChain alloc] init];</span><br><span class="line">    </span><br><span class="line">[atm dispense:<span class="number">230</span>];</span><br><span class="line">    </span><br><span class="line">[atm dispense:<span class="number">70</span>];</span><br><span class="line">    </span><br><span class="line">[atm dispense:<span class="number">40</span>];</span><br><span class="line">    </span><br><span class="line">[atm dispense:<span class="number">10</span>];</span><br><span class="line"></span><br><span class="line">[atm dispense:<span class="number">8</span>];</span><br></pre></td></tr></table></figure>
<p>创建<code>ATMDispenseChain</code>的实例后，分别传入一些数值来看一下处理的结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">==================================</span><br><span class="line">ATM start dispensing of amount:230</span><br><span class="line">Dispensing 4 of 50</span><br><span class="line">Dispensing 1 of 20</span><br><span class="line">Dispensing 1 of 10</span><br><span class="line">==================================</span><br><span class="line">ATM start dispensing of amount:70</span><br><span class="line">Dispensing 1 of 50</span><br><span class="line">Dispensing 1 of 20</span><br><span class="line">==================================</span><br><span class="line">ATM start dispensing of amount:40</span><br><span class="line">Dispensing 2 of 20</span><br><span class="line">==================================</span><br><span class="line">ATM start dispensing of amount:10</span><br><span class="line">Dispensing 1 of 10</span><br><span class="line">==================================</span><br><span class="line">ATM start dispensing of amount:8</span><br><span class="line">Amount should be in multiple of 10</span><br></pre></td></tr></table></figure>
<p>从日志的输出可以看出，我们的责任链处理是没有问题的，针对每个不同的数值，<code>ATMDispenseChain</code>实例都作出了最正确的结果。</p>
<blockquote>
<p>需要注意的是，该代码示例中的责任链类（<code>ATMDispenseChain</code>）并没有在上述责任链模式的成员中。不过此处不必做过多纠结，我们在这里只是在业务上稍微多做一点处理罢了。其实也完全可以不封装这些节点，直接逐个调用<code>setNextChainNode:</code>方法组装责任链，然后将任务交给第一个处理者即可。</p>
</blockquote>
<p>需求完成了，是否可以做个重构？</p>
<p>我们回去看一下这三个具体处理者在<code>dispense:</code>方法的处理是非常相似的，他们的区别只有处理的面额数值的不同：而我们其实是创建了针对这三个面值的类，并将面值（50，20，10）硬编码在了这三个类中。这样做是有缺点的，因为如果后面的面额大小变了，或者增加或者减少面额的话我们会修改这些类或添加删除这些类（即使这也比不使用责任链模式的<code>if-else</code>要好一些）。</p>
<p>因此我们可以不创建这些与面额值硬编码的具体处理类，而是在初始化的时候直接将面额值注入到构造方法里面即可！这样一来，我们可以随意调整和修改面额了。下面我们做一下这个重构：</p>
<p>首先删除掉三个具体处理者<code>DispenseChainNodeFor50Yuan</code>,<code>DispenseChainNodeFor20Yuan</code>,<code>DispenseChainNodeFor10Yuan</code>。</p>
<p>接着在<code>DispenseChainNode</code>添加传入面额值的初始化方法以及面额值的成员变量：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== ADispenseChainNode.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">DispenseChainNode</span> : <span class="title">NSObject</span> &lt;<span class="title">DispenseProtocol</span>&gt;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">@protected</span> DispenseChainNode *_nextChainNode;</span><br><span class="line">    <span class="keyword">@protected</span> <span class="keyword">int</span> _dispenseValue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithDispenseValue:(<span class="keyword">int</span>)dispenseValue;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setNextChainNode:(DispenseChainNode *)chainNode;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== ADispenseChainNode.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">DispenseChainNode</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithDispenseValue:(<span class="keyword">int</span>)dispenseValue</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        _dispenseValue = dispenseValue;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setNextChainNode:(DispenseChainNode *)chainNode&#123;</span><br><span class="line">    </span><br><span class="line">    _nextChainNode = chainNode;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)dispense:(<span class="keyword">int</span>)amount&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (amount &gt;= _dispenseValue) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">int</span> count = amount/_dispenseValue;</span><br><span class="line">        <span class="keyword">int</span> remainder = amount % _dispenseValue;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Dispensing %d of %d"</span>,count,_dispenseValue);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (remainder != <span class="number">0</span>) &#123;</span><br><span class="line">            [_nextChainNode dispense:remainder];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        </span><br><span class="line">        [_nextChainNode dispense:amount];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>我们给<code>DispenseChainNode</code>添加了<code>initWithDispenseValue:</code>方法后，就可以根据需求随意生成不同面额的具体处理者了。</p>
<p>接着我们思考一下之前的<code>ATMDispenseChain</code>可以做哪些改变？</p>
<p>既然<code>DispenseChainNode</code>可以根据不同的面额值生成处理不同面额的具体处理者实例，那么对于串联多个具体处理者的类<code>ATMDispenseChain</code>是不是也可以添加一个注入面额数组的初始化方法呢？比如输入<code>[50,20,10]</code>的数组就可以生成50，20，10面额的具体处理者了；而且数组是有序的，传入数组的元素顺序就可以是责任链中节点的顺序。</p>
<p>思路有了，我们看一下具体实现：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== ATMDispenseChain.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ATMDispenseChain</span></span></span><br><span class="line">&#123;</span><br><span class="line">    DispenseChainNode *_firstChainNode;</span><br><span class="line">    DispenseChainNode *_finalChainNode;</span><br><span class="line">    <span class="keyword">int</span> _minimumValue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithDispenseNodeValues:(<span class="built_in">NSArray</span> *)nodeValues&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">self</span>)&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSUInteger</span> length = [nodeValues count];</span><br><span class="line">        </span><br><span class="line">        [nodeValues enumerateObjectsUsingBlock:^(<span class="built_in">NSNumber</span> * nodeValue, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</span><br><span class="line">            </span><br><span class="line">            DispenseChainNode *iterNode = [[DispenseChainNode alloc] initWithDispenseValue:[nodeValue intValue]];</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (idx == length - <span class="number">1</span> ) &#123;</span><br><span class="line">                _minimumValue = [nodeValue intValue];</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">self</span>-&gt;_firstChainNode) &#123;</span><br><span class="line">                </span><br><span class="line">                 <span class="comment">//because this chain is empty, so the first node and the final node will refer the same node instance</span></span><br><span class="line">                 <span class="keyword">self</span>-&gt;_firstChainNode =  iterNode;</span><br><span class="line">                 <span class="keyword">self</span>-&gt;_finalChainNode =  <span class="keyword">self</span>-&gt;_firstChainNode;</span><br><span class="line">                </span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//appending the next node, and setting the new final node</span></span><br><span class="line">                [<span class="keyword">self</span>-&gt;_finalChainNode setNextChainNode:iterNode];</span><br><span class="line">                 <span class="keyword">self</span>-&gt;_finalChainNode = iterNode;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)dispense:(<span class="keyword">int</span>)amount&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"=================================="</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"ATM start dispensing of amount:%d"</span>,amount);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (amount % _minimumValue != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Amount should be in multiple of %d"</span>,_minimumValue);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [ _firstChainNode dispense:amount];</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>重构后的<code>ATMDispenseChain</code>类新增了<code>initWithDispenseNodeValues:</code>方法，需要从外部传入面额值的数组。在这个方法里面根据传入的数组构造了整条责任链。</p>
<p>而在<code>dispense:</code>方法里面则是从责任链的第一个节点来处理面额，并在方法最前面取最小面额的值来做边界处理。</p>
<p>OK，到现在处理者类和责任链类都创建好了，我们看一下如何使用：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSArray</span> *dispenseNodeValues = @[@(<span class="number">100</span>),@(<span class="number">50</span>),@(<span class="number">20</span>),@(<span class="number">10</span>)];</span><br><span class="line"></span><br><span class="line">ATMDispenseChain *atm = [[ATMDispenseChain alloc] initWithDispenseNodeValues:dispenseNodeValues];</span><br><span class="line">    </span><br><span class="line">[atm dispense:<span class="number">230</span>];</span><br><span class="line">    </span><br><span class="line">[atm dispense:<span class="number">70</span>];</span><br><span class="line">    </span><br><span class="line">[atm dispense:<span class="number">40</span>];</span><br><span class="line">    </span><br><span class="line">[atm dispense:<span class="number">10</span>];</span><br><span class="line">    </span><br><span class="line">[atm dispense:<span class="number">8</span>];</span><br></pre></td></tr></table></figure>
<p>是不是感觉简洁多了？我们只需要传入一个面额值的数组即可构造出整条责任链并直接使用。来看一下日至输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">==================================</span><br><span class="line">ATM start dispensing of amount:230</span><br><span class="line">Dispensing 2 of 100</span><br><span class="line">Dispensing 1 of 20</span><br><span class="line">Dispensing 1 of 10</span><br><span class="line">==================================</span><br><span class="line">ATM start dispensing of amount:70</span><br><span class="line">Dispensing 1 of 50</span><br><span class="line">Dispensing 1 of 20</span><br><span class="line">==================================</span><br><span class="line">ATM start dispensing of amount:40</span><br><span class="line">Dispensing 2 of 20</span><br><span class="line">==================================</span><br><span class="line">ATM start dispensing of amount:10</span><br><span class="line">Dispensing 1 of 10</span><br><span class="line">==================================</span><br><span class="line">ATM start dispensing of amount:8</span><br><span class="line">Amount should be in multiple of 10</span><br></pre></td></tr></table></figure>
<p>从日志的输出结果上看，我们重构后的责任链方案没有问题。</p>
<p>下面看一下上面代码对应的类图。</p>
<h3 id="代码对应的类图-2"><a href="#代码对应的类图-2" class="headerlink" title="代码对应的类图"></a>代码对应的类图</h3><p>重构前：<br><img src="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/cp_2.png" alt="责任链模式代码示例类图一"></p>
<p>重构后：<br><img src="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/cp_3.png" alt="责任链模式代码示例类图二"></p>
<h2 id="优点-2"><a href="#优点-2" class="headerlink" title="优点"></a>优点</h2><ul>
<li>处理者之间的责任分离，处理者只要处理好自己的逻辑即可</li>
<li>方便修改每个处理者的处理逻辑，也方便删除或者添加处理者，或者改变责任链中处理者的顺序。</li>
</ul>
<h2 id="缺点-2"><a href="#缺点-2" class="headerlink" title="缺点"></a>缺点</h2><ul>
<li>因为需要在责任链上传递责任，直到找到合适的对象来处理，所以可能会导致处理的延迟。因此在延迟不允许过高的场景下不适合使用责任链模式。</li>
</ul>
<h2 id="iOS-SDK-和-JDK中的应用-2"><a href="#iOS-SDK-和-JDK中的应用-2" class="headerlink" title="iOS SDK 和 JDK中的应用"></a>iOS SDK 和 JDK中的应用</h2><ul>
<li>iOS SDK中的响应者链就是责任链模式的实践：如果当前视图无法响应则传递给下一层级视图。</li>
<li><code>servlet</code>中的<code>Filter</code>可以组成<code>FilterChain</code>，是责任链模式的一种实践。</li>
</ul>
<h1 id="四-状态模式"><a href="#四-状态模式" class="headerlink" title="四. 状态模式"></a>四. 状态模式</h1><h2 id="定义-3"><a href="#定义-3" class="headerlink" title="定义"></a>定义</h2><blockquote>
<p>在状态模式（State Pattern）：允许一个对象在其内部状态改变时，改变它的行为。</p>
</blockquote>
<h2 id="适用场景-3"><a href="#适用场景-3" class="headerlink" title="适用场景"></a>适用场景</h2><p>一个对象存在多个状态，不同状态下的行为会有不同，而且状态之间可以相互转换。</p>
<p>如果我们通过<code>if else</code>来判断对象的状态，那么代码中会包含大量与对象状态有关的条件语句，而且在添加，删除和更改这些状态的时候回比较麻烦；而如果使用状态模式。将状态对象分散到不同的类中，则可以消除 <code>if...else</code>等条件选择语句。</p>
<p>现在我们清楚了状态模式的适用场景，下面看一下状态模式的成员和类图。</p>
<h2 id="成员与类图-3"><a href="#成员与类图-3" class="headerlink" title="成员与类图"></a>成员与类图</h2><h3 id="成员-3"><a href="#成员-3" class="headerlink" title="成员"></a>成员</h3><p>状态模式一共只有四个成员：</p>
<ul>
<li>环境类（Context）：<strong>环境类</strong>引用了具体状态的实例。<strong>环境类持有的具体状态就是当前的状态</strong>，可以通过 set 方法将状态实例注入到环境类中。</li>
<li>抽象状态类（State）：<strong>抽象状态类</strong>声明具体状态类需要实现的接口。</li>
<li>具体状态类（Concrete State）：<strong>具体状态类</strong>实现抽象状态类声明的接口。</li>
</ul>
<p>下面通过类图来看一下各个成员之间的关系：</p>
<h3 id="模式类图-3"><a href="#模式类图-3" class="headerlink" title="模式类图"></a>模式类图</h3><p><img src="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/sp_1.png" alt="状态模式类图"></p>
<h2 id="代码示例-3"><a href="#代码示例-3" class="headerlink" title="代码示例"></a>代码示例</h2><h3 id="场景概述-3"><a href="#场景概述-3" class="headerlink" title="场景概述"></a>场景概述</h3><p>模拟一个程序员一天的生活，他有四个状态：</p>
<ol>
<li>醒着</li>
<li>睡觉中</li>
<li>写代码中</li>
<li>吃饭中</li>
</ol>
<blockquote>
<p>看这几个状态应该是个非常爱写代码的程序员 ^ ^</p>
</blockquote>
<h3 id="场景分析-3"><a href="#场景分析-3" class="headerlink" title="场景分析"></a>场景分析</h3><p>这个程序员有四个状态，但是有些状态之间是无法切换的：比如从睡觉是无法切换到写代码的（因为需要切换到醒着，然后才能到写代码）；从吃饭中是无法切换到醒着的，因为已经醒着了。</p>
<p>如果我们不使用状态模式，在切换状态的时候可能会写不少<code>if-else</code>判断，而且随着状态的增多，这些分支会变得更多，难以维护。</p>
<p>而如果我们使用状态模式，则可以将每个状态封装到一个类中，便于管理；而且在增加或减少状态时也会很方便。</p>
<p>下面我们看一下如何用代码来模拟该场景。</p>
<h3 id="代码实现-3"><a href="#代码实现-3" class="headerlink" title="代码实现"></a>代码实现</h3><p>  首先我们定义状态类：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== State.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">State</span> : <span class="title">NSObject</span>&lt;<span class="title">ActionProtocol</span>&gt;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">@protected</span> Coder *_coder;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithCoder:(Coder *)coder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== State.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">State</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithCoder:(Coder *)coder&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        _coder = coder;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>状态类持有一个<code>coder</code>，也就是程序员的实例，并遵循了<code>ActionProtocol</code>：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== ActionProtocol.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">ActionProtocol</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@optional</span>;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)wakeUp;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)fallAsleep;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)startCoding;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)startEating;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><code>ActionProtocol</code>定义了程序员的一些动作，这些动作是程序员的日常活动，也是触发状态切换的动作，因此<code>State</code>也需要遵循这个协议，因为它的子类需要实现这些操作。</p>
<p>接下来我们看一下<code>State</code>的子类，根据上面说的四种状态，我们定义下面四个状态子类：</p>
<p><code>StateAwake</code>:<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== StateAwake.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">StateAwake</span> : <span class="title">State</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">StateAwake</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)wakeUp&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Already awake, can not change state to awake again"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)startCoding&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Change state from awake to coding"</span>);</span><br><span class="line">    [_coder setState:(State *)[_coder stateCoding]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)startEating&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Change state from awake to eating"</span>);</span><br><span class="line">    [_coder setState:(State *)[_coder stateEating]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)fallAsleep&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Change state from awake to sleeping"</span>);</span><br><span class="line">    [_coder setState:(State *)[_coder stateSleeping]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p><code>StateSleeping</code>:<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== StateSleeping.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">StateSleeping</span> : <span class="title">State</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== StateSleeping.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">StateSleeping</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)wakeUp&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Change state from sleeping to awake"</span>);</span><br><span class="line">    [_coder setState:(State *)[_coder stateAwake]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)startCoding&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Already sleeping, can not change state to coding"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)startEating&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Already sleeping, can change state to eating"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)fallAsleep&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Already sleeping, can not change state to sleeping again"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p><code>StateEating</code>:<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== StateEating.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">StateEating</span> : <span class="title">State</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== StateEating.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">StateEating</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)wakeUp&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Already awake, can not change state to awake again"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)startCoding&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"New idea came out! change state from eating to coding"</span>);</span><br><span class="line">    [_coder setState:(State *)[_coder stateCoding]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)startEating&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Already eating, can not change state to eating again"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)fallAsleep&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Too tired, change state from eating to sleeping"</span>);</span><br><span class="line">    [_coder setState:(State *)[_coder stateSleeping]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p>“StateCoding”:<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== StateCoding.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">StateCoding</span> : <span class="title">State</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== StateCoding.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">StateCoding</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)wakeUp&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Already awake, can not change state to awake again"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)startCoding&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Already coding, can not change state to coding again"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)startEating&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Too hungry, change state from coding to eating"</span>);</span><br><span class="line">    [_coder setState:(State *)[_coder stateEating]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)fallAsleep&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Too tired, change state from coding to sleeping"</span>);</span><br><span class="line">    [_coder setState:(State *)[_coder stateSleeping]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p>从上面的类可以看出，在有些状态之间的转换是失效的，有些是可以的。<br>比如相同状态的切换是无效的；从 <code>sleeping</code>无法切换到<code>coding</code>，但是反过来可以，因为可能写代码累了就直接睡了。</p>
<p>下面我们看一下程序员类的实现：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== Coder.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Coder</span> : <span class="title">NSObject</span>&lt;<span class="title">ActionProtocol</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) StateAwake *stateAwake;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) StateCoding *stateCoding;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) StateEating *stateEating;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) StateSleeping *stateSleeping;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setState:(State *)state;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== Coder.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Coder</span></span></span><br><span class="line">&#123;</span><br><span class="line">    State *_currentState;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        _stateAwake = [[StateAwake alloc] initWithCoder:<span class="keyword">self</span>];</span><br><span class="line">        _stateCoding = [[StateCoding alloc] initWithCoder:<span class="keyword">self</span>];</span><br><span class="line">        _stateEating = [[StateEating alloc] initWithCoder:<span class="keyword">self</span>];</span><br><span class="line">        _stateSleeping = [[StateSleeping alloc] initWithCoder:<span class="keyword">self</span>];</span><br><span class="line">        </span><br><span class="line">        _currentState = _stateAwake;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setState:(State *)state&#123;</span><br><span class="line">    </span><br><span class="line">    _currentState = state;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)wakeUp&#123;</span><br><span class="line">    </span><br><span class="line">    [_currentState wakeUp];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)startCoding&#123;</span><br><span class="line">    </span><br><span class="line">    [_currentState startCoding];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)startEating&#123;</span><br><span class="line">    </span><br><span class="line">    [_currentState startEating];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)fallAsleep&#123;</span><br><span class="line">    </span><br><span class="line">    [_currentState fallAsleep];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>从上面的代码我们可以看到，程序员类持有一个当前的状态的实例，在初始化后默认的状态为<code>awake</code>，并对外提供一个<code>setState:</code>的方法来切换状态。而且在初始化方法里，我们实例化了所有的状态，目的是在切换状态中时使用，详见具体状态类的方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)startEating&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Too hungry, change state from coding to eating"</span>);</span><br><span class="line">    [_coder setState:(State *)[_coder stateEating]];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>上面这段代码有点绕，可能需要多看几遍源码才能理解（这里面<code>[_coder stateEating]</code>是调用了<code>coder</code>的一个<code>get</code>方法，返回了<code>stateEating</code>这个实例）。</p>
</blockquote>
<p>最后，在程序员的动作方法里面，实际上调用的是当前状态对应的方法（这也就是为何程序员类和状态类都要遵循<code>ActionProtocol</code>的原因）。</p>
<p>这样，我们的状态类，状态子类，程序员类都声明好了。我们看一下如何使用：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Coder *coder = [[Coder alloc] init];</span><br><span class="line">    </span><br><span class="line"><span class="comment">//change to awake.. failed</span></span><br><span class="line">[coder wakeUp];<span class="comment">//Already awake, can not change state to awake again</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//change to coding</span></span><br><span class="line">[coder startCoding];<span class="comment">//Change state from awake to coding</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//change to sleep</span></span><br><span class="line">[coder fallAsleep];<span class="comment">//Too tired, change state from coding to sleeping</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//change to eat...failed</span></span><br><span class="line">[coder startEating];<span class="comment">//Already sleeping, can change state to eating</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//change to wake up</span></span><br><span class="line">[coder wakeUp];<span class="comment">//Change state from sleeping to awake</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//change wake up...failed</span></span><br><span class="line">[coder wakeUp];<span class="comment">//Already awake, can not change state to awake again</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//change to eating</span></span><br><span class="line">[coder startEating];<span class="comment">//Change state from awake to eating</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//change to coding</span></span><br><span class="line">[coder startCoding];<span class="comment">//New idea came out! change state from eating to coding</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//change to sleep</span></span><br><span class="line">[coder fallAsleep];<span class="comment">//Too tired, change state from coding to sleeping</span></span><br></pre></td></tr></table></figure>
<p>在上面的代码里，我们实例化了一个程序员类，接着不断调用一些触发状态改变的方法。我们把每次状态切换的日至输出注释到了代码右侧，可以看到在一些状态的切换是不允许的：</p>
<ul>
<li>比如从上到下的第一个<code>[coder wakeUp]</code>：因为程序员对象初始化后默认是<code>awake</code>状态，所以无法切换到相同的状态</li>
<li>比如从上到下的第一个<code>[coder startEating]</code>:在睡觉时是无法直接切换到<code>eating</code>状态；而在后面wake以后，再执行<code>[coder startEating]</code>就成功了。</li>
</ul>
<p>从上面的例子可以看出，使用状态模式不需要去写<code>if-else</code>，而且如果今后想添加一个状态，只需要再创建一个状态子类，并在新的状态子类添加好对所有状态的处理，并在之前的状态子类中添加上对新状态的处理即可。即便我们修改了之前定义好的状态子类，但是这样也总比使用庞大的<code>if-else</code>要方便多。</p>
<p>下面看一下上面代码对应的类图。</p>
<h3 id="代码对应的类图-3"><a href="#代码对应的类图-3" class="headerlink" title="代码对应的类图"></a>代码对应的类图</h3><p><img src="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/sp_2.png" alt="状态模式代码示例类图"></p>
<h2 id="优点-3"><a href="#优点-3" class="headerlink" title="优点"></a>优点</h2><ol>
<li>把各种状态的转换逻辑，分布到不同的类中，减少相互间的依赖。</li>
</ol>
<h2 id="缺点-3"><a href="#缺点-3" class="headerlink" title="缺点"></a>缺点</h2><ol>
<li>增加新的状态类需要修改状态转换的源码，而且增加新的行为也要修改原来的状态类（前提是新的行为和原来的状态有关系）。</li>
<li>过多的状态会增加系统中的类的个数，增加系统的复杂性。</li>
</ol>
<h2 id="iOS-SDK-和-JDK中的应用-3"><a href="#iOS-SDK-和-JDK中的应用-3" class="headerlink" title="iOS SDK 和 JDK中的应用"></a>iOS SDK 和 JDK中的应用</h2><ul>
<li>javax包下的<code>LifyCycle</code>是状态模式的一种实现</li>
</ul>
<h1 id="五-命令模式"><a href="#五-命令模式" class="headerlink" title="五. 命令模式"></a>五. 命令模式</h1><h2 id="定义-4"><a href="#定义-4" class="headerlink" title="定义"></a>定义</h2><blockquote>
<p>命令模式(Command Pattern)：命令（或请求）被封装成对象。客户端将命令（或请求）对象先传递给调用对象。调用对象再把该命令（或请求）对象传给合适的，可处理该命令（或请求）的对象来做处理。</p>
</blockquote>
<p>由定义可以看出，在命令模式中，命令被封装成了对象，而发送命令的客户端与处理命令的接收者中间被调用对象隔开了，这种设计的原因或者适用的场景是什么样的呢？</p>
<h2 id="适用场景-4"><a href="#适用场景-4" class="headerlink" title="适用场景"></a>适用场景</h2><p>在有些场景下，任务的处理可能不是需要立即执行的：可能需要记录（日至），撤销或重试（网络请求）。那么在这些场景下，如果任务的请求者和执行者是紧耦合状态下的话就可能会将很多其他执行策略的代码和立即执行的代码混合到一起。</p>
<p>这些其他执行策略，我们暂时称之为<strong>控制和管理</strong>策略，而如果我们如果想控制和管理请求，就需要：</p>
<ol>
<li>把请求抽象出来</li>
<li>让另外一个角色来负责控制和管理请求的任务</li>
</ol>
<p>因此命令模式就是为此场景量身打造的，它通过：</p>
<ol>
<li>把请求封装成对象</li>
<li>使用调用者在客户端和请求处理者之间来做一个“拦截”，方便对请求对象做控制和管理。</li>
</ol>
<p>现在我们清楚了命令模式的适用场景，下面看一下命令模式的成员和类图。</p>
<h2 id="成员与类图-4"><a href="#成员与类图-4" class="headerlink" title="成员与类图"></a>成员与类图</h2><h3 id="成员-4"><a href="#成员-4" class="headerlink" title="成员"></a>成员</h3><p>不包括请求的发起者（客户端），命令模式共有四个成员：</p>
<ul>
<li>抽象命令类（Command）：<strong>命令类</strong>负责声明命令的接口。</li>
<li>具体命令类（Concrete Command）：<strong>具体命令类</strong>负责实现抽象命令类声明的接口</li>
<li>调用者（Invoker）：<strong>调用者</strong>负责将具体命令类的实例传递给接收者</li>
<li>接收者（Receiver）：<strong>接收者</strong>负责处理命令</li>
</ul>
<p>下面通过类图来看一下命令模式各个成员之间的关系：</p>
<h3 id="模式类图-4"><a href="#模式类图-4" class="headerlink" title="模式类图"></a>模式类图</h3><p><img src="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/cd_1.png" alt="命令模式类图"></p>
<h2 id="代码示例-4"><a href="#代码示例-4" class="headerlink" title="代码示例"></a>代码示例</h2><h3 id="场景概述-4"><a href="#场景概述-4" class="headerlink" title="场景概述"></a>场景概述</h3><p>模拟一个使用遥控器开灯和关灯的例子。</p>
<h3 id="场景分析-4"><a href="#场景分析-4" class="headerlink" title="场景分析"></a>场景分析</h3><p>在这个例子中，使用遥控器的人就是客户端，TA发起开启或关闭灯的命令给遥控器（调用者）。然后调用者将命令传递给接收者（灯）。</p>
<p>在这里，人是不直接接触灯的，开启和关闭的命令是通过遥控器来做的转发，最后传达给灯来执行。</p>
<p>下面我们看一下如何用代码来模拟该场景。</p>
<h3 id="代码实现-4"><a href="#代码实现-4" class="headerlink" title="代码实现"></a>代码实现</h3><p>首先我们创建接收者，灯类：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== Light.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Light</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)lightOn;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)lightOff;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== Light.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Light</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)lightOn&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Light on"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)lightOff&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Light off"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>灯类声明并实现了两个接口：开灯接口和关灯接口，来让外部执行开灯和关灯的操作。</p>
<p>接着我们创建抽象命令类和具体命令类：</p>
<p>抽象命令类：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== Command.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Command</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)excute;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== Command.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Command</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>抽象命令类声明了一个执行命令的接口<code>excute</code>，这个接口由它的子类，也就是具体命令类来实现。</p>
<p>因为这里面只有开灯和关灯两种命令，所以我们创建两个具体命令类来继承上面的抽象命令类：</p>
<p>开灯命令<code>CommandLightOn</code>：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== CommandLightOn.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">CommandLightOn</span> : <span class="title">Command</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithLight:(Light *)light;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== CommandLightOn.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">CommandLightOn</span></span></span><br><span class="line">&#123;</span><br><span class="line">    Light *_light;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithLight:(Light *)light&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        _light = light;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)excute&#123;</span><br><span class="line">    </span><br><span class="line">    [_light lightOn];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关灯命令<code>CommandLightOff</code>：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== CommandLightOff.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">CommandLightOff</span> : <span class="title">Command</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithLight:(Light *)light;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== CommandLightOff.m ==================</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">CommandLightOff</span></span></span><br><span class="line">&#123;</span><br><span class="line">    Light *_light;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithLight:(Light *)light&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        _light = light;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)excute&#123;</span><br><span class="line">    </span><br><span class="line">    [_light lightOff];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>我们可以看到这两个具体命令类分别以自己的方式实现了它们的父类声明的<code>excute</code>接口。</p>
</blockquote>
<p>最后我们创建链接客户端和接收者的调用者类，也就是遥控器类<code>RemoteControl</code>：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== RemoteControl.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">RemoteControl</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setCommand:(Command *)command;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)pressButton;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== RemoteControl.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">RemoteControl</span></span></span><br><span class="line">&#123;</span><br><span class="line">    Command *_command;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setCommand:(Command *)command&#123;</span><br><span class="line">    </span><br><span class="line">    _command = command;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)pressButton&#123;</span><br><span class="line">    </span><br><span class="line">    [_command excute];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>遥控器类使用<code>set</code>方法注入了具体命令类，并向外提供了<code>pressButton</code>这个方法来内部调用已传入的具体命令类的<code>excute</code>方法。</p>
<p>最后我们看一下客户端是如何操作这些类的：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== client ==================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//init Light and Command instance</span></span><br><span class="line"><span class="comment">//inject light instance into command instance</span></span><br><span class="line">Light *light = [[Light alloc] init];</span><br><span class="line">CommandLightOn *co = [[CommandLightOn alloc] initWithLight:light];</span><br><span class="line">    </span><br><span class="line"><span class="comment">//set command on instance into remote control instance</span></span><br><span class="line">RemoteControl *rm = [[RemoteControl alloc] init];</span><br><span class="line">[rm setCommand:co];</span><br><span class="line">    </span><br><span class="line"><span class="comment">//excute command（light  on command）</span></span><br><span class="line">[rm pressButton];</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="comment">//inject light instance into command off instance</span></span><br><span class="line">CommandLightOff *cf = [[CommandLightOff alloc] initWithLight:light];</span><br><span class="line"></span><br><span class="line"><span class="comment">//change to off command</span></span><br><span class="line">[rm setCommand:cf];</span><br><span class="line"></span><br><span class="line"><span class="comment">//excute command（light  close command）</span></span><br><span class="line">[rm pressButton];</span><br></pre></td></tr></table></figure>
<p>看一下日至输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[11851:1190777] Light on</span><br><span class="line">[11851:1190777] Light off</span><br></pre></td></tr></table></figure>
<p>从上面的代码可以看到，我们首先准备好具体命令类的实例，然后将其传递给遥控器类，最后触发遥控器的<code>pressButton</code>方法来间接触发<code>light</code>对象的相应操作。</p>
<p>下面看一下上面代码对应的类图。</p>
<h3 id="代码对应的类图-4"><a href="#代码对应的类图-4" class="headerlink" title="代码对应的类图"></a>代码对应的类图</h3><p><img src="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/cd_2.png" alt="命令模式代码示例类图"></p>
<h2 id="优点-4"><a href="#优点-4" class="headerlink" title="优点"></a>优点</h2><ul>
<li>将命令的发起者和命令的执行者分离，降低系统的耦合度</li>
<li>便于批量处理命令，比如日至队列的实现；便于命令的撤销或重试，比如网络请求等</li>
</ul>
<h2 id="缺点-4"><a href="#缺点-4" class="headerlink" title="缺点"></a>缺点</h2><ul>
<li>需要针对每一个命令创建一个命令对象。如果系统中的命令过多，会造成系统中存在大量的命令类，提高系统的复杂度。</li>
</ul>
<h2 id="iOS-SDK-和-JDK中的应用-4"><a href="#iOS-SDK-和-JDK中的应用-4" class="headerlink" title="iOS SDK 和 JDK中的应用"></a>iOS SDK 和 JDK中的应用</h2><ul>
<li>在JDK中，<code>java.lang.Runnable</code>是使用命令模式的经典场景，Runnable接口可以作为抽象的命令，而实现了Runnable的线程即是具体的命令。</li>
</ul>
<h1 id="六-观察者模式"><a href="#六-观察者模式" class="headerlink" title="六. 观察者模式"></a>六. 观察者模式</h1><h2 id="定义-5"><a href="#定义-5" class="headerlink" title="定义"></a>定义</h2><blockquote>
<p>观察者模式(Observer Pattern)：定义对象间的一种一对多的依赖关系，使得每当一个对象状态发生改变时，其相关依赖对象都可以到通知并做相应针对性的处理。</p>
</blockquote>
<h2 id="适用场景-5"><a href="#适用场景-5" class="headerlink" title="适用场景"></a>适用场景</h2><p>凡是涉及到一对一或者一对多的对象交互场景都可以使用观察者模式。通常我们使用观察者模式实现一个对象的改变会令其他一个或多个对象发生改变的需求，比如换肤功能，监听列表滚动的偏移量等等。</p>
<p>现在我们清楚了观察者模式的适用场景，下面看一下观察者模式的成员和类图。</p>
<h2 id="成员与类图-5"><a href="#成员与类图-5" class="headerlink" title="成员与类图"></a>成员与类图</h2><h3 id="成员-5"><a href="#成员-5" class="headerlink" title="成员"></a>成员</h3><p>观察者模式有四个成员：</p>
<ul>
<li>目标（Subject）：<strong>目标</strong>是被观察的角色，声明添加和删除观察者以及通知观察者的接口。</li>
<li>具体目标（Concrete Subject）：<strong>具体目标</strong>实现目标类声明的接口，保存所有观察者的实例（通过集合的形式）。在被观察的状态发生变化时，给所有登记过的观察者发送通知。</li>
<li>观察者（Observer）：<strong>观察者</strong>定义具体观察者的更新接口，以便在收到通知时实现一些操作。</li>
<li>具体观察者（Concrete Observer）：<strong>具体观察者</strong>实现抽象观察者定义的更新接口。</li>
</ul>
<p>下面通过类图来看一下各个成员之间的关系：</p>
<h3 id="模式类图-5"><a href="#模式类图-5" class="headerlink" title="模式类图"></a>模式类图</h3><p><img src="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/op_1.png" alt="观察者模式类图"></p>
<h2 id="代码示例-5"><a href="#代码示例-5" class="headerlink" title="代码示例"></a>代码示例</h2><h3 id="场景概述-5"><a href="#场景概述-5" class="headerlink" title="场景概述"></a>场景概述</h3><p>模拟这样的一个场景：客户（投资者）订阅理财顾问的建议购买不同价格的股票。当价格信息变化时，所有客户会收到通知（可以使短信，邮件等等），随后客户查看最新数据并进行操作。</p>
<h3 id="场景分析-5"><a href="#场景分析-5" class="headerlink" title="场景分析"></a>场景分析</h3><p>一个理财顾问可能服务于多个客户，而且消息需要及时传达到各个客户那边；而客户接收到这些消息后，需要对这些消息做出相应的措施。这种一对多的通知场景我们可以使用观察者模式：理财顾问是被观察的目标（Subject），而TA的客户则是观察者（Observer）。</p>
<p>下面我们看一下如何用代码来模拟该场景。</p>
<h3 id="代码实现-5"><a href="#代码实现-5" class="headerlink" title="代码实现"></a>代码实现</h3><p>首先我们定义观察者<code>Observer</code>:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== Observer.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Observer</span> : <span class="title">NSObject</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">@protected</span> Subject *_subject;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithSubject:(Subject *)subject;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)update;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== Observer.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Observer</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithSubject:(Subject *)subject&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        _subject = subject;</span><br><span class="line">       [_subject addObserver:<span class="keyword">self</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)update&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"implementation by subclasses"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Observer</code>类是具体观察者的父类，它声明了一个传入目标类（<code>Subject</code>）的构造方法并在构造方法里持有这个传入的实例。而且在这个构造方法里，调用了<code>Subject</code>的‘添加观察者’的方法，即<code>addObserver:</code>,目的是将当前的观察者实例放入<code>Subject</code>的用来保存观察者实例的集合中（具体操作可以在下面讲解<code>Subject</code>类的部分看到）</p>
<p>另外它也定义了<code>update</code>方法供子类使用。</p>
<p>下面我们看一下具体观察者类<code>Investor</code>:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== Investor.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Investor</span> : <span class="title">Observer</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== Investor.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Investor</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)update&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">float</span> buyingPrice = [_subject getBuyingPrice];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"investor %p buy stock of price:%.2lf"</span>,<span class="keyword">self</span>,buyingPrice);    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>具体观察者实现了该协议中定义的方法<code>update</code>方法，在这个方法里面，首先通过<code>getBuyingPrice</code>方法获得到最新的在监听的数据<code>buyingPrice</code>，然后再做其他操作。这里为了方便展示，直接使用日至打印出当前的具体观察者实例的内存地址和当前监听的最新值。</p>
<p>下面我们声明一下目标类和具体目标类：</p>
<p>目标类<code>Subject</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== Subject.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Subject</span> : <span class="title">NSObject</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">@protected</span> <span class="keyword">float</span> _buyingPrice;</span><br><span class="line">    <span class="keyword">@protected</span> <span class="built_in">NSMutableArray</span> &lt;Observer *&gt;*_observers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addObserver:(Observer *) observer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)removeObserver:(Observer *) observer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)notifyObservers;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setBuyingPrice:(<span class="keyword">float</span>)price;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">double</span>)getBuyingPrice;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== Subject.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Subject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        _observers = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addObserver:( Observer * ) observer&#123;</span><br><span class="line">    </span><br><span class="line">    [_observers addObject:observer];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)removeObserver:( Observer *) observer&#123;</span><br><span class="line">    </span><br><span class="line">    [_observers removeObject:observer];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)notifyObservers&#123;</span><br><span class="line">    </span><br><span class="line">    [_observers enumerateObjectsUsingBlock:^(Observer *  _Nonnull observer, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</span><br><span class="line">        </span><br><span class="line">        [observer update];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setBuyingPrice:(<span class="keyword">float</span>)price&#123;</span><br><span class="line">    </span><br><span class="line">    _buyingPrice = price;</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> notifyObservers];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">double</span>)getBuyingPrice&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> _buyingPrice;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>目标类持有一个可变数组，用来保存观察自己的观察者们；并且还提供了增加，删除观察者的接口，也提供了通知所有观察者的接口。</p>
<p>而且它持有一个数据<code>buyingPrice</code>，这个数据就是让外部观察者观察的数据。尤其注意它向外界提供的<code>setBuyingPrice:</code>方法：当外部调用这个方法，也就是要更新<code>buyingPrice</code>这个数据时，目标类调用了<code>notifyObservers</code>方法来告知当前所有观察自己的观察者们：我更新了。</p>
<p>而<code>getBuyingPrice</code>就是用来返回当前的<code>buyingPrice</code>的值的，一般是在观察者们收到更新通知后，主动调动这个方法获取的（具体看上面<code>Investor</code>类的实现）。</p>
<p>OK，现在抽象目标类定义好了，下面我们看一下具体目标类<code>FinancialAdviser</code>：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== FinancialAdviser.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">FinancialAdviser</span> : <span class="title">Subject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== FinancialAdviser.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">FinancialAdviser</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>因为所有的接口的事先已经在<code>Subject</code>类定义好了，所以我们只需新建一个我们需要的子类即可（如果有不同于父类的操作的话还是可以按照自己的方式定义）。</p>
<p>下面我们看一下观察者的机制是如何实现的：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">FinancialAdviser *fa = [[FinancialAdviser alloc] init];</span><br><span class="line">    </span><br><span class="line">Investor *iv1 = [[Investor alloc] initWithSubject:fa];</span><br><span class="line">    </span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"====== first advice ========"</span>);</span><br><span class="line">[fa setBuyingPrice:<span class="number">1.3</span>];</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">Investor *iv2 = [[Investor alloc] initWithSubject:fa];</span><br><span class="line">Investor *iv3 = [[Investor alloc] initWithSubject:fa];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"====== second advice ========"</span>);</span><br><span class="line">[fa setBuyingPrice:<span class="number">2.6</span>];</span><br></pre></td></tr></table></figure>
<p>从代码中可以看到，我们最开始向<code>FinancialAdviser</code>(具体目标类)添加了一个具体观察者类的实例<code>iv1</code>，然后<code>FinancialAdviser</code>的实例<code>fa</code>便通知了所有观察者（此时的观察者只有<code>iv1</code>）。</p>
<p>后面我们继续向<code>fa</code>添加了<code>iv2</code>和<code>iv3</code>后发送通知。此时三个观察者都收到了消息。</p>
<p>在下面的日至输出中也可以看到，内存地址<code>0x600003094c00</code>就是<code>iv1</code>，<code>0x600003083680</code>和<code>0x600003083690</code>就是<code>iv2</code>和<code>iv3</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">====== first advice ========</span><br><span class="line">investor 0x600003094c00 buy stock of price:1.30</span><br><span class="line">====== second advice ========</span><br><span class="line">investor 0x600003094c00 buy stock of price:2.60</span><br><span class="line">investor 0x600003083680 buy stock of price:2.60</span><br><span class="line">investor 0x600003083690 buy stock of price:2.60</span><br></pre></td></tr></table></figure>
<p>下面看一下上面代码对应的类图。</p>
<h3 id="代码对应的类图-5"><a href="#代码对应的类图-5" class="headerlink" title="代码对应的类图"></a>代码对应的类图</h3><p><img src="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/op_2.png" alt="观察者模式代码示例类图"></p>
<h2 id="优点-5"><a href="#优点-5" class="headerlink" title="优点"></a>优点</h2><ul>
<li>观察者模式在观察目标和观察者之间建立了一个抽象的耦合。</li>
<li>可实现广播的，一对多的通信</li>
</ul>
<h2 id="缺点-5"><a href="#缺点-5" class="headerlink" title="缺点"></a>缺点</h2><ul>
<li>如果一个观察目标对象有很多直接和间接的观察者的话，会需要比较多的通信时间。</li>
<li>需要注意观察者和观察目标之间是否有循环引用。</li>
</ul>
<h2 id="iOS-SDK-和-JDK中的应用-5"><a href="#iOS-SDK-和-JDK中的应用-5" class="headerlink" title="iOS SDK 和 JDK中的应用"></a>iOS SDK 和 JDK中的应用</h2><ul>
<li>在 iOS SDK 中的 KVO 与 NSNotification 是观察者模式的应用。</li>
<li>在JDK的<code>java.util</code>包中，提供了<code>Observable</code>类以及<code>Observer</code>接口，它们构成了Java语言对观察者模式的支持。</li>
</ul>
<h1 id="七-中介者模式"><a href="#七-中介者模式" class="headerlink" title="七. 中介者模式"></a>七. 中介者模式</h1><h2 id="定义-6"><a href="#定义-6" class="headerlink" title="定义"></a>定义</h2><blockquote>
<p>中介者模式(Mediator Pattern)：用一个中介对象来封装一系列的对象交互，中介者使各对象之间不需要显式地相互引用，从而使其耦合松散，而且可以独立地改变它们之间的交互。</p>
</blockquote>
<h2 id="适用场景-6"><a href="#适用场景-6" class="headerlink" title="适用场景"></a>适用场景</h2><p>系统结构可能会日益变得复杂，对象之间存在大量的相互关联和调用，系统的整体结构容易变为网状结构。在这种情况下，如果需要修改某一个对象，则可能会要跟踪和该对象关联的其他所有对象，并进行处理。耦合越多，修改的地方就会越多。</p>
<p>如果我们使用中介者对象，则可以将系统的网状结构变成以中介者为中心的星型结构。中介者承担了中转作用和协调作用，简化了对象之间的交互，而且还可以给对象间的交互进行进一步的控制。</p>
<p>现在我们清楚了中介者模式的适用场景，下面看一下中介者模式的成员和类图。</p>
<h2 id="成员与类图-6"><a href="#成员与类图-6" class="headerlink" title="成员与类图"></a>成员与类图</h2><h3 id="成员-6"><a href="#成员-6" class="headerlink" title="成员"></a>成员</h3><p>中介者模式一共有四个成员：</p>
<ol>
<li>抽象中介者（Mediator）：<strong>抽象中介者</strong>定义具体中介者需要实现的接口。</li>
<li>具体中介者（Concrete Mediator）：<strong>具体中介者</strong>实现抽象中介者定义的接口，承担多个具体同事类之间的中介者的角色。</li>
<li>抽象同事类（Colleague）：<strong>抽象同事类</strong>定义具体同事类需要实现的接口。</li>
<li>具体同事类（Concrete Colleague）：<strong>具体同事类</strong>实现抽象同事类定义的接口。</li>
</ol>
<h3 id="模式类图-6"><a href="#模式类图-6" class="headerlink" title="模式类图"></a>模式类图</h3><p><img src="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/mp_1.png" alt="状态模式类图"></p>
<h2 id="代码示例-6"><a href="#代码示例-6" class="headerlink" title="代码示例"></a>代码示例</h2><h3 id="场景概述-6"><a href="#场景概述-6" class="headerlink" title="场景概述"></a>场景概述</h3><p>模拟一个多人对话的场景：当一个人发出消息后，另外的那些人可以收到该消息。</p>
<h3 id="场景分析-6"><a href="#场景分析-6" class="headerlink" title="场景分析"></a>场景分析</h3><p>假设一共有A，B，C三个人，那么当A发出消息后，需要分别传递给B，C二人。如果三个人直接相互通信，可能伪代码会是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A sent message to B</span><br><span class="line">A sent message to C</span><br></pre></td></tr></table></figure>
<p>而且随着人数的增多，代码行数也会变多，这显然是不合理的。</p>
<p>因此在这种场景下，我们需要使用中介者模式，在所有人中间来做一个消息的多路转发：当A发出消息后，由中介者来发送给B和C:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A sent message to Mediator ;</span><br><span class="line">Mediator sent message to B &amp; C</span><br></pre></td></tr></table></figure>
<p>下面我们看一下如何用代码来模拟该场景。</p>
<h3 id="代码实现-6"><a href="#代码实现-6" class="headerlink" title="代码实现"></a>代码实现</h3><p>首先我们创建通话的用户类<code>User</code>:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== User.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">User</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithName:(<span class="built_in">NSString</span> *)name mediator:(ChatMediator *)mediator;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)sendMessage:(<span class="built_in">NSString</span> *)message;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)receivedMessage:(<span class="built_in">NSString</span> *)message;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== User.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">User</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSString</span> *_name;</span><br><span class="line">    ChatMediator *_chatMediator;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithName:(<span class="built_in">NSString</span> *)name mediator:(ChatMediator *)mediator&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        _name = name;</span><br><span class="line">        _chatMediator = mediator;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)sendMessage:(<span class="built_in">NSString</span> *)message&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"================"</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@ sent message:%@"</span>,_name,message);</span><br><span class="line">    [_chatMediator sendMessage:message fromUser:<span class="keyword">self</span>];</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)receivedMessage:(<span class="built_in">NSString</span> *)message&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@ has received message:%@"</span>,_name,message);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>用户类在初始化的时候需要传入中介者的实例，并持有。目的是为了在后面发送消息的时候把消息转发给中介者。</p>
<p>另外，用户类还对外提供了发送消息和接收消息的接口。而在发送消息的方法内部其实调用的是中介者的发送消息的方法（因为中介者持有了所有用户的实例，因此可以做多路转发），具体是如何做的我们可以看下中介者类<code>ChatMediator</code>的实现：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//================== ChatMediator.h ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ChatMediator</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addUser:(User *)user;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)sendMessage:(<span class="built_in">NSString</span> *)message fromUser:(User *)user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================== ChatMediator.m ==================</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ChatMediator</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> &lt;User *&gt;*_userList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        _userList = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addUser:(User *)user&#123;</span><br><span class="line"></span><br><span class="line">    [_userList addObject:user];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)sendMessage:(<span class="built_in">NSString</span> *)message fromUser:(User *)user&#123;</span><br><span class="line">    </span><br><span class="line">    [_userList enumerateObjectsUsingBlock:^(User * _Nonnull iterUser, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (iterUser != user) &#123;</span><br><span class="line">            [iterUser receivedMessage:message];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>中介者类提供了<code>addUser:</code>的方法，因此我们可以不断将用户添加到这个中介者里面（可以看做是注册行为或是“加入群聊”）。在每次加入一个<code>User</code>实例后，都将这个实例添加到中介者持有的这个可变数组里。于是在将来中介者就可以通过遍历数组的方式来做消息的多路转发，具体实现可以看<code>sendMessage:fromUser:</code>这个方法。</p>
<p>到现在为止，用户类和中介者类都创建好了，我们看一下消息是如何转发的：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ChatMediator *cm = [[ChatMediator alloc] init];</span><br><span class="line">    </span><br><span class="line">User *user1 = [[User alloc] initWithName:<span class="string">@"Jack"</span> mediator:cm];</span><br><span class="line">User *user2 = [[User alloc] initWithName:<span class="string">@"Bruce"</span> mediator:cm];</span><br><span class="line">User *user3 = [[User alloc] initWithName:<span class="string">@"Lucy"</span> mediator:cm];</span><br><span class="line">    </span><br><span class="line">[cm addUser:user1];</span><br><span class="line">[cm addUser:user2];</span><br><span class="line">[cm addUser:user3];</span><br><span class="line">    </span><br><span class="line">[user1 sendMessage:<span class="string">@"happy"</span>];</span><br><span class="line">[user2 sendMessage:<span class="string">@"new"</span>];</span><br><span class="line">[user3 sendMessage:<span class="string">@"year"</span>];</span><br></pre></td></tr></table></figure>
<p>从代码中可以看到，我们这里创建了三个用户，分别加入到了聊天中介者对象里。再后面我们分别让每个用户发送了一条消息。我们下面通过日至输出来看一下每个用户的消息接收情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[13806:1284059] ================</span><br><span class="line">[13806:1284059] Jack sent message:happy</span><br><span class="line">[13806:1284059] Bruce has received message:happy</span><br><span class="line">[13806:1284059] Lucy has received message:happy</span><br><span class="line">[13806:1284059] ================</span><br><span class="line">[13806:1284059] Bruce sent message:new</span><br><span class="line">[13806:1284059] Jack has received message:new</span><br><span class="line">[13806:1284059] Lucy has received message:new</span><br><span class="line">[13806:1284059] ================</span><br><span class="line">[13806:1284059] Lucy sent message:year</span><br><span class="line">[13806:1284059] Jack has received message:year</span><br><span class="line">[13806:1284059] Bruce has received message:year</span><br></pre></td></tr></table></figure>
<p>下面看一下上面代码对应的类图。</p>
<h3 id="代码对应的类图-6"><a href="#代码对应的类图-6" class="headerlink" title="代码对应的类图"></a>代码对应的类图</h3><p><img src="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/design-pattern-behavior/mp_2.png" alt="中介者模式代码示例类图"></p>
<h2 id="优点-6"><a href="#优点-6" class="headerlink" title="优点"></a>优点</h2><ul>
<li>中介者使各对象不需要显式地相互引用，从而使其耦合松散。</li>
</ul>
<h2 id="缺点-6"><a href="#缺点-6" class="headerlink" title="缺点"></a>缺点</h2><ul>
<li>在具体中介者类中包含了同事类之间的交互细节，可能会导致具体中介者类非常复杂，使得其难以维护。</li>
</ul>
<h2 id="iOS-SDK-和-JDK中的应用-6"><a href="#iOS-SDK-和-JDK中的应用-6" class="headerlink" title="iOS SDK 和 JDK中的应用"></a>iOS SDK 和 JDK中的应用</h2><ul>
<li>JDK中的<code>Timer</code>就是中介者类的实现，而配合使用的<code>TimerTask</code>则是同事类的实现。</li>
</ul>
<hr>
<p>到这里设计模式中的行为型模式就介绍完了，读者可以结合UML类图和demo的代码来理解每个设计模式的特点和相互之间的区别，希望读者可以有所收获。</p>
<p>本篇博客的代码和类图都保存在我的GitHub库中：<a href="https://github.com/knightsj/object-oriented-design">knightsj:object-oriented-design</a>中的 <a href="https://github.com/knightsj/object-oriented-design#23-%E8%A1%8C%E4%B8%BA%E5%9E%8B%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F">Chapter 2.3</a>。</p>
<p>到本篇为止，面向对象设计系列暂时告一段落，短期内不会有新的文章出来。读者朋友们可以随时给我提意见或沟通。</p>
<p>该系列前面的三篇文章：</p>
<ul>
<li><a href="https://juejin.im/post/5b9526c1e51d450e69731dc2" target="_blank" rel="noopener">面向对象设计的六大设计原则（附 Demo 及 UML 类图）</a></li>
<li><a href="https://juejin.im/post/5b9526c1e51d450e69731dc2" target="_blank" rel="noopener">面向对象设计的设计模式（一）：创建型设计模式（附 Demo 及 UML 类图）</a></li>
<li><a href="https://juejin.im/post/5bfd60455188257a5a24f2d4" target="_blank" rel="noopener">面向对象设计的设计模式（二）：结构型模式（附 Demo &amp; UML类图）</a></li>
</ul>
<h1 id="参考书籍和教程"><a href="#参考书籍和教程" class="headerlink" title="参考书籍和教程"></a>参考书籍和教程</h1><ul>
<li><a href="https://book.douban.com/subject/1052241/" target="_blank" rel="noopener">《设计模式 可复用面向对象软件的基础》</a></li>
<li><a href="https://book.douban.com/subject/6920082/" target="_blank" rel="noopener">《Objective-C 编程之道：iOS设计模式解析》</a></li>
<li><a href="https://book.douban.com/subject/2243615/" target="_blank" rel="noopener">《Head First 设计模式》</a></li>
<li><a href="https://book.douban.com/subject/2334288/" target="_blank" rel="noopener">《大话设计模式》</a></li>
</ul>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/images/wechatpay.jpg" alt="J_Knight_ WeChat Pay">
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/images/alipay.jpg" alt="J_Knight_ Alipay">
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag"># iOS</a>
          
            <a href="/tags/Objectice-C/" rel="tag"># Objectice-C</a>
          
            <a href="/tags/Object-Oriented/" rel="tag"># Object-Oriented</a>
          
            <a href="/tags/Design-Pattern/" rel="tag"># Design Pattern</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/01/01/《简约之美：软件设计之道》- 读书笔记/" rel="next" title="《简约之美 - 软件设计之道》- 读书笔记">
                <i class="fa fa-chevron-left"></i> 《简约之美 - 软件设计之道》- 读书笔记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="http://jknight-blog.oss-cn-shanghai.aliyuncs.com/blog-config/jknight_avatar.png" alt="J_Knight_">
          <p class="site-author-name" itemprop="name">J_Knight_</p>
           
              <p class="site-description motion-element" itemprop="description">iOS开发，正在研究设计模式 | 下方的RSS已修复，欢迎订阅</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">61</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">17</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/knightsj" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://weibo.com/1929625262/profile?rightmod=1&wvr=6&mod=personinfo" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://juejin.im/user/57f8ffda2e958a005581e3c0" target="_blank" title="掘金">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  掘金
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.jianshu.com/u/3dd433cb3ea1" target="_blank" title="简书">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  简书
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#一-模板方法模式"><span class="nav-number">1.</span> <span class="nav-text">一. 模板方法模式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#定义"><span class="nav-number">1.1.</span> <span class="nav-text">定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#适用场景"><span class="nav-number">1.2.</span> <span class="nav-text">适用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#成员与类图"><span class="nav-number">1.3.</span> <span class="nav-text">成员与类图</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#成员"><span class="nav-number">1.3.1.</span> <span class="nav-text">成员</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模式类图"><span class="nav-number">1.3.2.</span> <span class="nav-text">模式类图</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#代码示例"><span class="nav-number">1.4.</span> <span class="nav-text">代码示例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#场景概述"><span class="nav-number">1.4.1.</span> <span class="nav-text">场景概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#场景分析"><span class="nav-number">1.4.2.</span> <span class="nav-text">场景分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代码实现"><span class="nav-number">1.4.3.</span> <span class="nav-text">代码实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代码对应的类图"><span class="nav-number">1.4.4.</span> <span class="nav-text">代码对应的类图</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#优点"><span class="nav-number">1.5.</span> <span class="nav-text">优点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#缺点"><span class="nav-number">1.6.</span> <span class="nav-text">缺点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#iOS-SDK-和-JDK中的应用"><span class="nav-number">1.7.</span> <span class="nav-text">iOS SDK 和 JDK中的应用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二-策略模式"><span class="nav-number">2.</span> <span class="nav-text">二. 策略模式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#定义-1"><span class="nav-number">2.1.</span> <span class="nav-text">定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#适用场景-1"><span class="nav-number">2.2.</span> <span class="nav-text">适用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#成员与类图-1"><span class="nav-number">2.3.</span> <span class="nav-text">成员与类图</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#成员-1"><span class="nav-number">2.3.1.</span> <span class="nav-text">成员</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模式类图-1"><span class="nav-number">2.3.2.</span> <span class="nav-text">模式类图</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#代码示例-1"><span class="nav-number">2.4.</span> <span class="nav-text">代码示例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#场景概述-1"><span class="nav-number">2.4.1.</span> <span class="nav-text">场景概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#场景分析-1"><span class="nav-number">2.4.2.</span> <span class="nav-text">场景分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代码实现-1"><span class="nav-number">2.4.3.</span> <span class="nav-text">代码实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代码对应的类图-1"><span class="nav-number">2.4.4.</span> <span class="nav-text">代码对应的类图</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#优点-1"><span class="nav-number">2.5.</span> <span class="nav-text">优点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#缺点-1"><span class="nav-number">2.6.</span> <span class="nav-text">缺点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#iOS-SDK-和-JDK中的应用-1"><span class="nav-number">2.7.</span> <span class="nav-text">iOS SDK 和 JDK中的应用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#三-责任链模式"><span class="nav-number">3.</span> <span class="nav-text">三. 责任链模式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#定义-2"><span class="nav-number">3.1.</span> <span class="nav-text">定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#适用场景-2"><span class="nav-number">3.2.</span> <span class="nav-text">适用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#成员与类图-2"><span class="nav-number">3.3.</span> <span class="nav-text">成员与类图</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#成员-2"><span class="nav-number">3.3.1.</span> <span class="nav-text">成员</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模式类图-2"><span class="nav-number">3.3.2.</span> <span class="nav-text">模式类图</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#代码示例-2"><span class="nav-number">3.4.</span> <span class="nav-text">代码示例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#场景概述-2"><span class="nav-number">3.4.1.</span> <span class="nav-text">场景概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#场景分析-2"><span class="nav-number">3.4.2.</span> <span class="nav-text">场景分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代码实现-2"><span class="nav-number">3.4.3.</span> <span class="nav-text">代码实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代码对应的类图-2"><span class="nav-number">3.4.4.</span> <span class="nav-text">代码对应的类图</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#优点-2"><span class="nav-number">3.5.</span> <span class="nav-text">优点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#缺点-2"><span class="nav-number">3.6.</span> <span class="nav-text">缺点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#iOS-SDK-和-JDK中的应用-2"><span class="nav-number">3.7.</span> <span class="nav-text">iOS SDK 和 JDK中的应用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#四-状态模式"><span class="nav-number">4.</span> <span class="nav-text">四. 状态模式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#定义-3"><span class="nav-number">4.1.</span> <span class="nav-text">定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#适用场景-3"><span class="nav-number">4.2.</span> <span class="nav-text">适用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#成员与类图-3"><span class="nav-number">4.3.</span> <span class="nav-text">成员与类图</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#成员-3"><span class="nav-number">4.3.1.</span> <span class="nav-text">成员</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模式类图-3"><span class="nav-number">4.3.2.</span> <span class="nav-text">模式类图</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#代码示例-3"><span class="nav-number">4.4.</span> <span class="nav-text">代码示例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#场景概述-3"><span class="nav-number">4.4.1.</span> <span class="nav-text">场景概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#场景分析-3"><span class="nav-number">4.4.2.</span> <span class="nav-text">场景分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代码实现-3"><span class="nav-number">4.4.3.</span> <span class="nav-text">代码实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代码对应的类图-3"><span class="nav-number">4.4.4.</span> <span class="nav-text">代码对应的类图</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#优点-3"><span class="nav-number">4.5.</span> <span class="nav-text">优点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#缺点-3"><span class="nav-number">4.6.</span> <span class="nav-text">缺点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#iOS-SDK-和-JDK中的应用-3"><span class="nav-number">4.7.</span> <span class="nav-text">iOS SDK 和 JDK中的应用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#五-命令模式"><span class="nav-number">5.</span> <span class="nav-text">五. 命令模式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#定义-4"><span class="nav-number">5.1.</span> <span class="nav-text">定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#适用场景-4"><span class="nav-number">5.2.</span> <span class="nav-text">适用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#成员与类图-4"><span class="nav-number">5.3.</span> <span class="nav-text">成员与类图</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#成员-4"><span class="nav-number">5.3.1.</span> <span class="nav-text">成员</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模式类图-4"><span class="nav-number">5.3.2.</span> <span class="nav-text">模式类图</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#代码示例-4"><span class="nav-number">5.4.</span> <span class="nav-text">代码示例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#场景概述-4"><span class="nav-number">5.4.1.</span> <span class="nav-text">场景概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#场景分析-4"><span class="nav-number">5.4.2.</span> <span class="nav-text">场景分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代码实现-4"><span class="nav-number">5.4.3.</span> <span class="nav-text">代码实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代码对应的类图-4"><span class="nav-number">5.4.4.</span> <span class="nav-text">代码对应的类图</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#优点-4"><span class="nav-number">5.5.</span> <span class="nav-text">优点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#缺点-4"><span class="nav-number">5.6.</span> <span class="nav-text">缺点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#iOS-SDK-和-JDK中的应用-4"><span class="nav-number">5.7.</span> <span class="nav-text">iOS SDK 和 JDK中的应用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#六-观察者模式"><span class="nav-number">6.</span> <span class="nav-text">六. 观察者模式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#定义-5"><span class="nav-number">6.1.</span> <span class="nav-text">定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#适用场景-5"><span class="nav-number">6.2.</span> <span class="nav-text">适用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#成员与类图-5"><span class="nav-number">6.3.</span> <span class="nav-text">成员与类图</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#成员-5"><span class="nav-number">6.3.1.</span> <span class="nav-text">成员</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模式类图-5"><span class="nav-number">6.3.2.</span> <span class="nav-text">模式类图</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#代码示例-5"><span class="nav-number">6.4.</span> <span class="nav-text">代码示例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#场景概述-5"><span class="nav-number">6.4.1.</span> <span class="nav-text">场景概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#场景分析-5"><span class="nav-number">6.4.2.</span> <span class="nav-text">场景分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代码实现-5"><span class="nav-number">6.4.3.</span> <span class="nav-text">代码实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代码对应的类图-5"><span class="nav-number">6.4.4.</span> <span class="nav-text">代码对应的类图</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#优点-5"><span class="nav-number">6.5.</span> <span class="nav-text">优点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#缺点-5"><span class="nav-number">6.6.</span> <span class="nav-text">缺点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#iOS-SDK-和-JDK中的应用-5"><span class="nav-number">6.7.</span> <span class="nav-text">iOS SDK 和 JDK中的应用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#七-中介者模式"><span class="nav-number">7.</span> <span class="nav-text">七. 中介者模式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#定义-6"><span class="nav-number">7.1.</span> <span class="nav-text">定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#适用场景-6"><span class="nav-number">7.2.</span> <span class="nav-text">适用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#成员与类图-6"><span class="nav-number">7.3.</span> <span class="nav-text">成员与类图</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#成员-6"><span class="nav-number">7.3.1.</span> <span class="nav-text">成员</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模式类图-6"><span class="nav-number">7.3.2.</span> <span class="nav-text">模式类图</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#代码示例-6"><span class="nav-number">7.4.</span> <span class="nav-text">代码示例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#场景概述-6"><span class="nav-number">7.4.1.</span> <span class="nav-text">场景概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#场景分析-6"><span class="nav-number">7.4.2.</span> <span class="nav-text">场景分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代码实现-6"><span class="nav-number">7.4.3.</span> <span class="nav-text">代码实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代码对应的类图-6"><span class="nav-number">7.4.4.</span> <span class="nav-text">代码对应的类图</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#优点-6"><span class="nav-number">7.5.</span> <span class="nav-text">优点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#缺点-6"><span class="nav-number">7.6.</span> <span class="nav-text">缺点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#iOS-SDK-和-JDK中的应用-6"><span class="nav-number">7.7.</span> <span class="nav-text">iOS SDK 和 JDK中的应用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考书籍和教程"><span class="nav-number">8.</span> <span class="nav-text">参考书籍和教程</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">J_Knight_</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  





  






  





  

  

  

  

</body>
</html>
